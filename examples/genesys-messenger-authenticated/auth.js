!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ConversalyseAuth={})}(this,(function(e){"use strict";const t=e=>"object"==typeof e&&null!==e,r=e=>t(e)&&!(e instanceof RegExp)&&!(e instanceof Error)&&!(e instanceof Date),n=Symbol("mapObjectSkip"),s=(e,t,o,i=new WeakMap)=>{if(o={deep:!1,target:{},...o},i.has(e))return i.get(e);i.set(e,o.target);const{target:a}=o;delete o.target;const c=e=>e.map((e=>r(e)?s(e,t,o,i):e));if(Array.isArray(e))return c(e);for(const[d,h]of Object.entries(e)){const l=t(d,h,e);if(l===n)continue;let[p,u,{shouldRecurse:f=!0}={}]=l;"__proto__"!==p&&(o.deep&&f&&r(u)&&(u=Array.isArray(u)?c(u):s(u,t,o,i)),a[p]=u)}return a};function o(e,r,n){if(!t(e))throw new TypeError(`Expected an object, got \`${e}\` (${typeof e})`);return s(e,r,n)}const i=/[\p{Lu}]/u,a=/[\p{Ll}]/u,c=/^[\p{Lu}](?![\p{Lu}])/gu,d=/([\p{Alpha}\p{N}_]|$)/u,h=/[_.\- ]+/,l=new RegExp("^"+h.source),p=new RegExp(h.source+d.source,"gu"),u=new RegExp("\\d+"+d.source,"gu");function f(e,t){if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(t={pascalCase:!1,preserveConsecutiveUppercase:!1,...t},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const r=!1===t.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(t.locale),n=!1===t.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(t.locale);if(1===e.length)return h.test(e)?"":t.pascalCase?n(e):r(e);return e!==r(e)&&(e=((e,t,r,n)=>{let s=!1,o=!1,c=!1,d=!1;for(let h=0;h<e.length;h++){const l=e[h];d=!(h>2)||"-"===e[h-3],s&&i.test(l)?(e=e.slice(0,h)+"-"+e.slice(h),s=!1,c=o,o=!0,h++):o&&c&&a.test(l)&&(!d||n)?(e=e.slice(0,h-1)+"-"+e.slice(h-1),c=o,o=!1,s=!0):(s=t(l)===l&&r(l)!==l,c=o,o=r(l)===l&&t(l)!==l)}return e})(e,r,n,t.preserveConsecutiveUppercase)),e=e.replace(l,""),e=t.preserveConsecutiveUppercase?((e,t)=>(c.lastIndex=0,e.replaceAll(c,(e=>t(e)))))(e,r):r(e),t.pascalCase&&(e=n(e.charAt(0))+e.slice(1)),((e,t)=>(p.lastIndex=0,u.lastIndex=0,e.replaceAll(u,((r,n,s)=>["_","-"].includes(e.charAt(s+r.length))?r:t(r))).replaceAll(p,((e,r)=>t(r)))))(e,n)}class g extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if("number"==typeof e.maxAge&&0===e.maxAge)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if("function"==typeof this.onEviction)for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return"number"==typeof t.expiry&&t.expiry<=Date.now()&&("function"==typeof this.onEviction&&this.onEviction(e,t.value),this.delete(e))}_getOrDeleteIfExpired(e,t){if(!1===this._deleteIfExpired(e,t))return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;if(!this.cache.has(t)){!1===this._deleteIfExpired(t,r)&&(yield e)}}for(const e of this.cache){const[t,r]=e;!1===this._deleteIfExpired(t,r)&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(!1===this._deleteIfExpired(e,t))return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const n="number"==typeof r&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:n}):this._set(e,{value:t,expiry:n}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):!!this.oldCache.has(e)&&!this._deleteIfExpired(e,this.oldCache.get(e))}peek(e){return this.cache.has(e)?this._peek(e,this.cache):this.oldCache.has(e)?this._peek(e,this.oldCache):void 0}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;!1===this._deleteIfExpired(t,r)&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;if(!this.cache.has(t)){!1===this._deleteIfExpired(t,r)&&(yield[t,r.value])}}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;!1===this._deleteIfExpired(n,s)&&(yield[n,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;if(!this.cache.has(n)){!1===this._deleteIfExpired(n,s)&&(yield[n,s.value])}}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,n]of this.entriesAscending())e.call(t,n,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}const y=new g({maxSize:1e5}),w=e=>!("object"!=typeof e||null===e||e instanceof RegExp||e instanceof Error||e instanceof Date),m=(e,t={})=>{if(!w(e))return e;const{exclude:r,pascalCase:n=!1,stopPaths:s,deep:i=!1,preserveConsecutiveUppercase:a=!1}=t,c=new Set(s),d=e=>(t,s)=>{if(i&&w(s)){const r=void 0===e?t:`${e}.${t}`;c.has(r)||(s=o(s,d(r)))}if(!r||!((e,t)=>e.some((e=>"string"==typeof e?e===t:(e.lastIndex=0,e.test(t)))))(r,t)){const e=n?`${t}_`:t;if(y.has(e))t=y.get(e);else{const r=f(t,{pascalCase:n,locale:!1,preserveConsecutiveUppercase:a});t.length<100&&y.set(e,r),t=r}}return[t,s]};return o(e,d(void 0))};function S(e,t){return Array.isArray(e)?Object.keys(e).map((r=>m(e[r],t))):m(e,t)}var _;e.ReservedScope=void 0,(e.ReservedScope||(e.ReservedScope={})).OpenId="openid",e.ReservedResource=void 0,(e.ReservedResource||(e.ReservedResource={})).Organization="urn:conversalyse:resource:organizations",e.UserScope=void 0,(_=e.UserScope||(e.UserScope={})).Profile="profile",_.Email="email",_.Phone="phone",_.Address="address",_.CustomData="custom_data",_.Identities="identities",_.Roles="roles",_.Organizations="urn:conversalyse:scope:organizations",_.OrganizationRoles="urn:conversalyse:scope:organization_roles";const v=Object.freeze({[e.UserScope.Profile]:["name","picture","username"],[e.UserScope.Email]:["email","email_verified"],[e.UserScope.Phone]:["phone_number","phone_number_verified"],[e.UserScope.Address]:[],[e.UserScope.Roles]:["roles"],[e.UserScope.Organizations]:["organizations"],[e.UserScope.OrganizationRoles]:["organization_roles"],[e.UserScope.CustomData]:[],[e.UserScope.Identities]:[]}),k=Object.freeze({[e.UserScope.Profile]:[],[e.UserScope.Email]:[],[e.UserScope.Phone]:[],[e.UserScope.Address]:[],[e.UserScope.Roles]:[],[e.UserScope.Organizations]:[],[e.UserScope.OrganizationRoles]:[],[e.UserScope.CustomData]:["custom_data"],[e.UserScope.Identities]:["identities"]});Object.freeze(Object.fromEntries(Object.values(e.UserScope).map((e=>[e,[...v[e],...k[e]]]))));const E="urn:conversalyse:organization:",b={formUrlEncoded:{"Content-Type":"application/x-www-form-urlencoded"}};var T,A,I;!function(e){e.AuthorizationCode="authorization_code",e.RefreshToken="refresh_token"}(T||(T={})),function(e){e.ClientId="client_id",e.Code="code",e.CodeChallenge="code_challenge",e.CodeChallengeMethod="code_challenge_method",e.CodeVerifier="code_verifier",e.Error="error",e.ErrorDescription="error_description",e.GrantType="grant_type",e.IdToken="id_token",e.IdTokenHint="id_token_hint",e.LoginHint="login_hint",e.PostLogoutRedirectUri="post_logout_redirect_uri",e.Prompt="prompt",e.RedirectUri="redirect_uri",e.RefreshToken="refresh_token",e.Resource="resource",e.ResponseType="response_type",e.Scope="scope",e.State="state",e.Token="token",e.InteractionMode="interaction_mode",e.OrganizationId="organization_id",e.FirstScreen="first_screen",e.Identifier="identifier",e.DirectSignIn="direct_sign_in",e.OneTimeToken="one_time_token"}(A||(A={})),e.Prompt=void 0,(I=e.Prompt||(e.Prompt={})).None="none",I.Consent="consent",I.Login="login";const C=t=>{const r=Object.values(e.ReservedScope),n=new Set([...r,e.UserScope.Profile,...t??[]]);return Array.from(n).join(" ")},R=t=>Array.isArray(t)?t.join(" "):t??e.Prompt.Consent,O=e=>Boolean(e),U=e=>O(e)?e:void 0,x=e=>e.replaceAll("-","+").replaceAll("_","/"),P=e=>{const t=x(e);return decodeURIComponent(escape(atob(t)))},j=e=>"object"==typeof e&&null!==e,K=Object.freeze({"id_token.invalid_iat":"Invalid issued at time in the ID token","id_token.invalid_token":"Invalid ID token","callback_uri_verification.redirect_uri_mismatched":"The callback URI mismatches the redirect URI.","callback_uri_verification.error_found":"Error found in the callback URI","callback_uri_verification.missing_state":"Missing state in the callback URI","callback_uri_verification.state_mismatched":"State mismatched in the callback URI","callback_uri_verification.missing_code":"Missing code in the callback URI",crypto_subtle_unavailable:"Crypto.subtle is unavailable in insecure contexts (non-HTTPS).",unexpected_response_error:"Unexpected response error from the server."});class D extends Error{constructor(e,t){super(K[e]),this.code=e,this.data=t,this.name="ConversalyseAuthError"}}class $ extends Error{constructor(e,t,r){super(t),this.code=e,this.cause=r,this.name="ConversalyseAuthRequestError"}}class J{constructor(e,t){this.error=e,this.errorDescription=t,this.name="OidcError"}}const M=(e,t,r)=>{if(!e.startsWith(t))throw new D("callback_uri_verification.redirect_uri_mismatched");const n=(e=>{const[,t=""]=e.split("?");return new URLSearchParams(t)})(e),s=U(n.get(A.Error)),o=U(n.get(A.ErrorDescription));if(s)throw new D("callback_uri_verification.error_found",new J(s,o));const i=n.get(A.State);if(!i)throw new D("callback_uri_verification.missing_state");if(i!==r)throw new D("callback_uri_verification.state_mismatched");const a=n.get(A.Code);if(!a)throw new D("callback_uri_verification.missing_code");return a};const W=e=>{const{1:t}=e.split(".");if(!t)throw new D("id_token.invalid_token");const r=P(t),n=JSON.parse(r);return function(e){if(!j(e))throw new TypeError("IdToken is expected to be an object");for(const t of["iss","sub","aud"])if("string"!=typeof e[t])throw new TypeError(`At path: IdToken.${t}: expected a string`);for(const t of["exp","iat"])if("number"!=typeof e[t])throw new TypeError(`At path: IdToken.${t}: expected a number`);for(const t of["at_hash","name","username","picture","email","phone_number"])if(void 0!==e[t]&&"string"!=typeof e[t]&&null!==e[t])throw new TypeError(`At path: IdToken.${t}: expected null or a string`);for(const t of["email_verified","phone_number_verified"])if(void 0!==e[t]&&"boolean"!=typeof e[t])throw new TypeError(`At path: IdToken.${t}: expected a boolean`)}(n),n};const z=e=>{const{1:t}=e.split(".");if(!t)return{};const r=P(t),n=JSON.parse(r);return function(e){if(!j(e))throw new TypeError("AccessToken is expected to be an object");for(const t of["jti","iss","sub","aud","client_id","scope"])if(void 0!==e[t]&&"string"!=typeof e[t]&&null!==e[t])throw new TypeError(`At path: AccessToken.${t}: expected null or a string`);for(const t of["exp","iat"])if(void 0!==e[t]&&"number"!=typeof e[t]&&null!==e[t])throw new TypeError(`At path: AccessToken.${t}: expected null or a number`)}(n),n};var H=crypto;const L=e=>e instanceof CryptoKey,N=new TextEncoder,V=new TextDecoder;const F=e=>{let t=e;t instanceof Uint8Array&&(t=V.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return(e=>{const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r})(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};class q extends Error{static get code(){return"ERR_JOSE_GENERIC"}constructor(e){super(e),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}class G extends q{static get code(){return"ERR_JWT_CLAIM_VALIDATION_FAILED"}constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=t,this.reason=r}}class B extends q{static get code(){return"ERR_JWT_EXPIRED"}constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_EXPIRED",this.claim=t,this.reason=r}}class Y extends q{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}static get code(){return"ERR_JOSE_ALG_NOT_ALLOWED"}}class X extends q{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}static get code(){return"ERR_JOSE_NOT_SUPPORTED"}}class Q extends q{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}static get code(){return"ERR_JWS_INVALID"}}class Z extends q{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}class ee extends q{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}static get code(){return"ERR_JWKS_INVALID"}}class te extends q{constructor(){super(...arguments),this.code="ERR_JWKS_NO_MATCHING_KEY",this.message="no applicable key found in the JSON Web Key Set"}static get code(){return"ERR_JWKS_NO_MATCHING_KEY"}}class re extends q{constructor(){super(...arguments),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS",this.message="multiple matching keys found in the JSON Web Key Set"}static get code(){return"ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}class ne extends q{constructor(){super(...arguments),this.code="ERR_JWKS_TIMEOUT",this.message="request timed out"}static get code(){return"ERR_JWKS_TIMEOUT"}}class se extends q{constructor(){super(...arguments),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED",this.message="signature verification failed"}static get code(){return"ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}function oe(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function ie(e,t){return e.name===t}function ae(e){return parseInt(e.name.slice(4),10)}function ce(e,t,...r){switch(t){case"HS256":case"HS384":case"HS512":{if(!ie(e.algorithm,"HMAC"))throw oe("HMAC");const r=parseInt(t.slice(2),10);if(ae(e.algorithm.hash)!==r)throw oe(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!ie(e.algorithm,"RSASSA-PKCS1-v1_5"))throw oe("RSASSA-PKCS1-v1_5");const r=parseInt(t.slice(2),10);if(ae(e.algorithm.hash)!==r)throw oe(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!ie(e.algorithm,"RSA-PSS"))throw oe("RSA-PSS");const r=parseInt(t.slice(2),10);if(ae(e.algorithm.hash)!==r)throw oe(`SHA-${r}`,"algorithm.hash");break}case"EdDSA":if("Ed25519"!==e.algorithm.name&&"Ed448"!==e.algorithm.name)throw oe("Ed25519 or Ed448");break;case"ES256":case"ES384":case"ES512":{if(!ie(e.algorithm,"ECDSA"))throw oe("ECDSA");const r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw oe(r,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}!function(e,t){if(t.length&&!t.some((t=>e.usages.includes(t)))){let e="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const r=t.pop();e+=`one of ${t.join(", ")}, or ${r}.`}else 2===t.length?e+=`one of ${t[0]} or ${t[1]}.`:e+=`${t[0]}.`;throw new TypeError(e)}}(e,r)}function de(e,t,...r){if(r.length>2){const t=r.pop();e+=`one of type ${r.join(", ")}, or ${t}.`}else 2===r.length?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}var he=(e,...t)=>de("Key must be ",e,...t);function le(e,t,...r){return de(`Key for the ${e} algorithm must be `,t,...r)}var pe=e=>L(e);const ue=["CryptoKey"];function fe(e){if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}const ge=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:r}=function(e){let t,r;switch(e.kty){case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new X('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new X('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"EdDSA":t={name:e.crv},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new X('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new X('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),n=[t,e.ext??!1,e.key_ops??r],s={...e};return delete s.alg,delete s.use,H.subtle.importKey("jwk",s,...n)};const ye=(e,t,r)=>{e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(e)?((e,t)=>{if(!(t instanceof Uint8Array)){if(!pe(t))throw new TypeError(le(e,t,...ue,"Uint8Array"));if("secret"!==t.type)throw new TypeError(`${ue.join(" or ")} instances for symmetric algorithms must be of type "secret"`)}})(e,t):((e,t,r)=>{if(!pe(t))throw new TypeError(le(e,t,...ue));if("secret"===t.type)throw new TypeError(`${ue.join(" or ")} instances for asymmetric algorithms must not be of type "secret"`);if(t.algorithm&&"verify"===r&&"private"===t.type)throw new TypeError(`${ue.join(" or ")} instances for asymmetric algorithm verifying must be of type "public"`);t.algorithm})(e,t,r)};const we=async(e,t,r,n)=>{const s=await function(e,t,r){if(L(t))return ce(t,e,r),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(he(t,...ue));return H.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}throw new TypeError(he(t,...ue,"Uint8Array"))}(e,t,"verify");((e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}})(e,s);const o=function(e,t){const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"EdDSA":return{name:t.name};default:throw new X(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}(e,s.algorithm);try{return await H.subtle.verify(o,s,r,n)}catch{return!1}};async function me(e,t,r){if(!fe(e))throw new Q("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new Q('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new Q("JWS Protected Header incorrect type");if(void 0===e.payload)throw new Q("JWS Payload missing");if("string"!=typeof e.signature)throw new Q("JWS Signature missing or incorrect type");if(void 0!==e.header&&!fe(e.header))throw new Q("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{const t=F(e.protected);n=JSON.parse(V.decode(t))}catch{throw new Q("JWS Protected Header is invalid")}if(!((...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let r;for(const e of t){const t=Object.keys(e);if(r&&0!==r.size)for(const e of t){if(r.has(e))return!1;r.add(e)}else r=new Set(t)}return!0})(n,e.header))throw new Q("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const s={...n,...e.header},o=function(e,t,r,n,s){if(void 0!==s.crit&&void 0===n.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!n||void 0===n.crit)return new Set;if(!Array.isArray(n.crit)||0===n.crit.length||n.crit.some((e=>"string"!=typeof e||0===e.length)))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let o;o=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t;for(const t of n.crit){if(!o.has(t))throw new X(`Extension Header Parameter "${t}" is not recognized`);if(void 0===s[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(o.get(t)&&void 0===n[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(n.crit)}(Q,new Map([["b64",!0]]),r?.crit,n,s);let i=!0;if(o.has("b64")&&(i=n.b64,"boolean"!=typeof i))throw new Q('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:a}=s;if("string"!=typeof a||!a)throw new Q('JWS "alg" (Algorithm) Header Parameter missing or invalid');const c=r&&((e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some((e=>"string"!=typeof e))))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)})("algorithms",r.algorithms);if(c&&!c.has(a))throw new Y('"alg" (Algorithm) Header Parameter value not allowed');if(i){if("string"!=typeof e.payload)throw new Q("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new Q("JWS Payload must be a string or an Uint8Array instance");let d=!1;"function"==typeof t&&(t=await t(n,e),d=!0),ye(a,t,"verify");const h=function(...e){const t=e.reduce(((e,{length:t})=>e+t),0),r=new Uint8Array(t);let n=0;for(const t of e)r.set(t,n),n+=t.length;return r}(N.encode(e.protected??""),N.encode("."),"string"==typeof e.payload?N.encode(e.payload):e.payload);let l;try{l=F(e.signature)}catch{throw new Q("Failed to base64url decode the signature")}if(!await we(a,t,l,h))throw new se;let p;if(i)try{p=F(e.payload)}catch{throw new Q("Failed to base64url decode the payload")}else p="string"==typeof e.payload?N.encode(e.payload):e.payload;const u={payload:p};return void 0!==e.protected&&(u.protectedHeader=n),void 0!==e.header&&(u.unprotectedHeader=e.header),d?{...u,key:t}:u}const Se=86400,_e=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i;var ve=e=>{const t=_e.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const r=parseFloat(t[2]);let n;switch(t[3].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":n=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":n=Math.round(60*r);break;case"hour":case"hours":case"hr":case"hrs":case"h":n=Math.round(3600*r);break;case"day":case"days":case"d":n=Math.round(r*Se);break;case"week":case"weeks":case"w":n=Math.round(604800*r);break;default:n=Math.round(31557600*r)}return"-"===t[1]||"ago"===t[4]?-n:n};const ke=e=>e.toLowerCase().replace(/^application\//,"");var Ee=(e,t,r={})=>{const{typ:n}=r;if(n&&("string"!=typeof e.typ||ke(e.typ)!==ke(n)))throw new G('unexpected "typ" JWT header value',"typ","check_failed");let s;try{s=JSON.parse(V.decode(t))}catch{}if(!fe(s))throw new Z("JWT Claims Set must be a top-level JSON object");const{requiredClaims:o=[],issuer:i,subject:a,audience:c,maxTokenAge:d}=r,h=[...o];void 0!==d&&h.push("iat"),void 0!==c&&h.push("aud"),void 0!==a&&h.push("sub"),void 0!==i&&h.push("iss");for(const e of new Set(h.reverse()))if(!(e in s))throw new G(`missing required "${e}" claim`,e,"missing");if(i&&!(Array.isArray(i)?i:[i]).includes(s.iss))throw new G('unexpected "iss" claim value',"iss","check_failed");if(a&&s.sub!==a)throw new G('unexpected "sub" claim value',"sub","check_failed");if(c&&(l=s.aud,p="string"==typeof c?[c]:c,!("string"==typeof l?p.includes(l):Array.isArray(l)&&p.some(Set.prototype.has.bind(new Set(l))))))throw new G('unexpected "aud" claim value',"aud","check_failed");var l,p;let u;switch(typeof r.clockTolerance){case"string":u=ve(r.clockTolerance);break;case"number":u=r.clockTolerance;break;case"undefined":u=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:f}=r,g=(y=f||new Date,Math.floor(y.getTime()/1e3));var y;if((void 0!==s.iat||d)&&"number"!=typeof s.iat)throw new G('"iat" claim must be a number',"iat","invalid");if(void 0!==s.nbf){if("number"!=typeof s.nbf)throw new G('"nbf" claim must be a number',"nbf","invalid");if(s.nbf>g+u)throw new G('"nbf" claim timestamp check failed',"nbf","check_failed")}if(void 0!==s.exp){if("number"!=typeof s.exp)throw new G('"exp" claim must be a number',"exp","invalid");if(s.exp<=g-u)throw new B('"exp" claim timestamp check failed',"exp","check_failed")}if(d){const e=g-s.iat;if(e-u>("number"==typeof d?d:ve(d)))throw new B('"iat" claim timestamp check failed (too far in the past)',"iat","check_failed");if(e<0-u)throw new G('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}return s};async function be(e,t,r){const n=await async function(e,t,r){if(e instanceof Uint8Array&&(e=V.decode(e)),"string"!=typeof e)throw new Q("Compact JWS must be a string or Uint8Array");const{0:n,1:s,2:o,length:i}=e.split(".");if(3!==i)throw new Q("Invalid Compact JWS");const a=await me({payload:s,protected:n,signature:o},t,r),c={payload:a.payload,protectedHeader:a.protectedHeader};return"function"==typeof t?{...c,key:a.key}:c}(e,t,r);if(n.protectedHeader.crit?.includes("b64")&&!1===n.protectedHeader.b64)throw new Z("JWTs MUST NOT use unencoded payload");const s={payload:Ee(n.protectedHeader,n.payload,r),protectedHeader:n.protectedHeader};return"function"==typeof t?{...s,key:n.key}:s}function Te(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(Ae)}function Ae(e){return fe(e)}class Ie{constructor(e){if(this._cached=new WeakMap,!Te(e))throw new ee("JSON Web Key Set malformed");var t;this._jwks=(t=e,"function"==typeof structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t)))}async getKey(e,t){const{alg:r,kid:n}={...e,...t?.header},s=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new X('Unsupported "alg" value for a JSON Web Key Set')}}(r),o=this._jwks.keys.filter((e=>{let t=s===e.kty;if(t&&"string"==typeof n&&(t=n===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t&&"EdDSA"===r&&(t="Ed25519"===e.crv||"Ed448"===e.crv),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES256K":t="secp256k1"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv}return t})),{0:i,length:a}=o;if(0===a)throw new te;if(1!==a){const e=new re,{_cached:t}=this;throw e[Symbol.asyncIterator]=async function*(){for(const e of o)try{yield await Ce(t,e,r)}catch{}},e}return Ce(this._cached,i,r)}}async function Ce(e,t,r){const n=e.get(t)||e.set(t,{}).get(t);if(void 0===n[r]){const e=await async function(e,t){if(!fe(e))throw new TypeError("JWK must be an object");switch(t||(t=e.alg),e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return F(e.k);case"RSA":if(void 0!==e.oth)throw new X('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return ge({...e,alg:t});default:throw new X('Unsupported "kty" (Key Type) Parameter value')}}({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new ee("JSON Web Key Set members must be public keys");n[r]=e}return n[r]}let Re;if("undefined"==typeof navigator||!navigator.userAgent?.startsWith?.("Mozilla/5.0 ")){Re=`${"jose"}/${"v5.2.2"}`}class Oe extends Ie{constructor(e,t){if(super({keys:[]}),this._jwks=void 0,!(e instanceof URL))throw new TypeError("url must be an instance of URL");this._url=new URL(e.href),this._options={agent:t?.agent,headers:t?.headers},this._timeoutDuration="number"==typeof t?.timeoutDuration?t?.timeoutDuration:5e3,this._cooldownDuration="number"==typeof t?.cooldownDuration?t?.cooldownDuration:3e4,this._cacheMaxAge="number"==typeof t?.cacheMaxAge?t?.cacheMaxAge:6e5}coolingDown(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cooldownDuration}fresh(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cacheMaxAge}async getKey(e,t){this._jwks&&this.fresh()||await this.reload();try{return await super.getKey(e,t)}catch(r){if(r instanceof te&&!1===this.coolingDown())return await this.reload(),super.getKey(e,t);throw r}}async reload(){this._pendingFetch&&("undefined"!=typeof WebSocketPair||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"undefined"!=typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this._pendingFetch=void 0);const e=new Headers(this._options.headers);Re&&!e.has("User-Agent")&&(e.set("User-Agent",Re),this._options.headers=Object.fromEntries(e.entries())),this._pendingFetch||(this._pendingFetch=(async(e,t,r)=>{let n,s,o=!1;"function"==typeof AbortController&&(n=new AbortController,s=setTimeout((()=>{o=!0,n.abort()}),t));const i=await fetch(e.href,{signal:n?n.signal:void 0,redirect:"manual",headers:r.headers}).catch((e=>{if(o)throw new ne;throw e}));if(void 0!==s&&clearTimeout(s),200!==i.status)throw new q("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await i.json()}catch{throw new q("Failed to parse the JSON Web Key Set HTTP response as JSON")}})(this._url,this._timeoutDuration,this._options).then((e=>{if(!Te(e))throw new ee("JSON Web Key Set malformed");this._jwks={keys:e.keys},this._jwksTimestamp=Date.now(),this._pendingFetch=void 0})).catch((e=>{throw this._pendingFetch=void 0,e}))),await this._pendingFetch}}class Ue{constructor(e,t=300){this.client=e,this.clockTolerance=t}async verifyIdToken(e){const{appId:t}=this.client.conversalyseConfig,{issuer:r,jwksUri:n}=await this.client.getOidcConfig();this.getJwtVerifyGetKey||=function(e,t){const r=new Oe(e,t);return async(e,t)=>r.getKey(e,t)}(new URL(n)),await(async(e,t,r,n,s=300)=>{const o=await be(e,n,{audience:t,issuer:r,clockTolerance:s});if(Math.abs((o.payload.iat??0)-Date.now()/1e3)>s)throw new D("id_token.invalid_iat")})(e,t,r,this.getJwtVerifyGetKey,this.clockTolerance)}}var xe,Pe;e.PersistKey=void 0,(xe=e.PersistKey||(e.PersistKey={})).IdToken="idToken",xe.RefreshToken="refreshToken",xe.AccessToken="accessToken",xe.SignInSession="signInSession",function(e){e.OpenidConfig="openidConfiguration",e.Jwks="jwks"}(Pe||(Pe={}));class je{constructor(e){Object.assign(this,e)}async setStorageItem(e,t){t?await this.storage.setItem(e,t):await this.storage.removeItem(e)}async getCachedObject(e){const t=await((e,t)=>{try{const n="function"==typeof e?e():e;return null===(r=n)||"object"!=typeof r&&"function"!=typeof r||!("then"in r)||"function"!=typeof r.then?n:n.catch((e=>{t?.(e)}))}catch(e){}var r})((async()=>{const t=await(this.unstable_cache?.getItem(e));return U(t&&JSON.parse(t))}));if(t&&"object"==typeof t)return t}async getWithCache(e,t){const r=await this.getCachedObject(e);if(r)return r;const n=await t();return await(this.unstable_cache?.setItem(e,JSON.stringify(n))),n}}const Ke=Object.freeze({"sign_in_session.invalid":"Invalid sign-in session.","sign_in_session.not_found":"Sign-in session not found.",not_authenticated:"Not authenticated.",fetch_user_info_failed:"Unable to fetch user info. The access token may be invalid.",user_cancelled:"The user cancelled the action.",missing_scope_organizations:`The \`${e.UserScope.Organizations}\` scope is required`});class De extends Error{constructor(e,t){super(Ke[e]),this.name="ConversalyseAuthClientError",this.code=e,this.data=t}}const $e=(e="",t,r=[])=>{return`${r.slice().sort().join(" ")}@${e}${n=t&&`#${t}`,O(n)?String(n):""}`;var n};function Je(e){const t=new Map;return async function(...r){const n=JSON.stringify(r),s=t.get(n);if(s)return s;const o=(async()=>{try{return await e.apply(this,r)}finally{t.delete(n)}})();return t.set(n,o),o}}class Me{get jwtVerifier(){return this.jwtVerifierInstance}constructor(t,r,n){this.getOidcConfig=function(e){let t,r=!1;return function(...n){return r||(r=!0,t=e.apply(this,n)),t}}(this.#e),this.getAccessToken=Je(this.#t),this.getOrganizationToken=Je(this.#r),this.clearAccessToken=Je(this.#n),this.clearAllTokens=Je(this.#s),this.handleSignInCallback=Je(this.#o),this.accessTokenMap=new Map,this.conversalyseConfig=(t=>{const{prompt:r=e.Prompt.Consent,scopes:n=[],resources:s,...o}=t;return{...o,prompt:r,scopes:t.includeReservedScopes??1?C(n).split(" "):n,resources:n.includes(e.UserScope.Organizations)?(i=[...s??[],e.ReservedResource.Organization],[...new Set(i)]):s};var i})(t),this.adapter=new je(r),this.jwtVerifierInstance=n(this),this.loadAccessTokenMap()}setJwtVerifier(e){this.jwtVerifierInstance="function"==typeof e?e(this):e}async isAuthenticated(){return Boolean(await this.getIdToken())}async getRefreshToken(){return this.adapter.storage.getItem("refreshToken")}async getIdToken(){return this.adapter.storage.getItem("idToken")}async getIdTokenClaims(){const e=await this.getIdToken();if(!e)throw new De("not_authenticated","ID token not found");return W(e)}async getAccessTokenClaims(e){const t=await this.getAccessToken(e);return z(t)}async getOrganizationTokenClaims(e){const t=await this.getOrganizationToken(e);return z(t)}async fetchUserInfo(){const{userinfoEndpoint:e}=await this.getOidcConfig(),t=await this.getAccessToken();if(!t)throw new De("fetch_user_info_failed");return(async(e,t,r)=>r(e,{headers:{Authorization:`Bearer ${t}`}}))(e,t,this.adapter.requester)}async signIn(e,t,r){const{redirectUri:n,postRedirectUri:s,firstScreen:o,identifiers:i,interactionMode:a,loginHint:c,directSignIn:d,extraParams:h,prompt:l,clearTokens:p}="string"==typeof e||e instanceof URL?{redirectUri:e,postRedirectUri:void 0,firstScreen:void 0,identifiers:void 0,interactionMode:t,loginHint:r,directSignIn:void 0,extraParams:void 0,prompt:void 0,clearTokens:!0}:e,u=n.toString(),f=s?.toString(),{appId:g,prompt:y,resources:w,scopes:m}=this.conversalyseConfig,{authorizationEndpoint:S}=await this.getOidcConfig(),[_,v]=await Promise.all([this.adapter.generateCodeVerifier(),this.adapter.generateState()]),k=await this.adapter.generateCodeChallenge(_),E=(({authorizationEndpoint:e,clientId:t,redirectUri:r,codeChallenge:n,state:s,scopes:o,resources:i,prompt:a,firstScreen:c,identifiers:d,interactionMode:h,loginHint:l,directSignIn:p,oneTimeToken:u,extraParams:f,includeReservedScopes:g=!0})=>{const y=new URLSearchParams({[A.ClientId]:t,[A.RedirectUri]:r,[A.CodeChallenge]:n,[A.CodeChallengeMethod]:"S256",[A.State]:s,[A.ResponseType]:"code",[A.Prompt]:R(a)}),w=g?C(o):o?.join(" ");w&&y.append(A.Scope,w),l&&y.append(A.LoginHint,l),p&&y.append(A.DirectSignIn,`${p.method}:${p.target}`);for(const e of i??[])y.append(A.Resource,e);if(c?y.append(A.FirstScreen,c):h&&y.append(A.InteractionMode,h),d&&d.length>0&&y.append(A.Identifier,d.join(" ")),u&&y.append(A.OneTimeToken,u),f)for(const[e,t]of Object.entries(f))y.append(e,t);return`${e}?${y.toString()}`})({authorizationEndpoint:S,clientId:g,redirectUri:u.toString(),codeChallenge:k,state:v,scopes:m,resources:w,prompt:l??y,firstScreen:o,identifiers:i,interactionMode:a,loginHint:c,directSignIn:d,extraParams:h});await Promise.all([this.setSignInSession({redirectUri:u,postRedirectUri:f,codeVerifier:_,state:v}),!1===p?void 0:this.clearAllTokens()]),await this.adapter.navigate(E,{redirectUri:u,for:"sign-in"})}async isSignInRedirected(e){const t=await this.getSignInSession();if(!t)return!1;const{redirectUri:r}=t,{origin:n,pathname:s,searchParams:o}=new URL(e);return`${n}${s}`===r}async isCallbackSignInRedirected(e){const t=await this.isSignInRedirected(e),{searchParams:r}=new URL(e);return t&&r.has("code")&&r.has("state")}async signOut(e){const{appId:t}=this.conversalyseConfig,{endSessionEndpoint:r,revocationEndpoint:n}=await this.getOidcConfig(),s=await this.getRefreshToken();if(s)try{await(async(e,t,r,n)=>n(e,{method:"POST",headers:b.formUrlEncoded,body:new URLSearchParams({[A.ClientId]:t,[A.Token]:r}).toString()}))(n,t,s,this.adapter.requester)}catch{}const o=(({endSessionEndpoint:e,clientId:t,postLogoutRedirectUri:r})=>{const n=new URLSearchParams({[A.ClientId]:t});return r&&n.append(A.PostLogoutRedirectUri,r),`${e}?${n.toString()}`})({endSessionEndpoint:r,postLogoutRedirectUri:e,clientId:t});await this.clearAllTokens(),await this.adapter.navigate(o,{redirectUri:e,for:"sign-out"})}async getSignInSession(){const e=await this.adapter.storage.getItem("signInSession");if(!e)return null;const t=JSON.parse(e);if(!j(r=t)||!["redirectUri","codeVerifier","state"].every((e=>"string"==typeof r[e])))throw new De("sign_in_session.invalid");var r;return t}async setSignInSession(t){return this.adapter.setStorageItem(e.PersistKey.SignInSession,t&&JSON.stringify(t))}async setIdToken(t){return this.adapter.setStorageItem(e.PersistKey.IdToken,t)}async setRefreshToken(t){return this.adapter.setStorageItem(e.PersistKey.RefreshToken,t)}async getAccessTokenByRefreshToken(e,t){const r=await this.getRefreshToken();if(!r)throw new De("not_authenticated","Refresh token not found");const n=$e(e,t),{appId:s}=this.conversalyseConfig,{tokenEndpoint:o}=await this.getOidcConfig(),i=Math.round(Date.now()/1e3),{accessToken:a,refreshToken:c,idToken:d,scope:h,expiresIn:l}=await(async(e,t)=>{const{clientId:r,tokenEndpoint:n,refreshToken:s,resource:o,organizationId:i,scopes:a}=e,c=new URLSearchParams;return c.append(A.ClientId,r),c.append(A.RefreshToken,s),c.append(A.GrantType,T.RefreshToken),o&&c.append(A.Resource,o),i&&c.append(A.OrganizationId,i),a?.length&&c.append(A.Scope,a.join(" ")),S(await t(n,{method:"POST",headers:b.formUrlEncoded,body:c.toString()}))})({clientId:s,tokenEndpoint:o,refreshToken:r,resource:e,organizationId:t},this.adapter.requester);return this.accessTokenMap.set(n,{token:a,scope:h,expiresAt:i+l}),await this.saveAccessTokenMap(),c&&await this.setRefreshToken(c),d&&(await this.jwtVerifier.verifyIdToken(d),await this.setIdToken(d)),a}async saveAccessTokenMap(){const e={};for(const[t,r]of this.accessTokenMap.entries())e[t]=r;await this.adapter.storage.setItem("accessToken",JSON.stringify(e))}async loadAccessTokenMap(){const e=await this.adapter.storage.getItem("accessToken");var t;if(e)try{const r=JSON.parse(e);if(!j(t=r)||!Object.values(t).every((e=>!!j(e)&&"string"==typeof e.token&&"string"==typeof e.scope&&"number"==typeof e.expiresAt)))return;this.accessTokenMap.clear();for(const[e,t]of Object.entries(r))this.accessTokenMap.set(e,t)}catch(e){console.warn(e)}}async#e(){return this.adapter.getWithCache(Pe.OpenidConfig,(async()=>{return(async(e,t)=>S(await t(e)))((e=this.conversalyseConfig.endpoint,t=this.conversalyseConfig.discoveryPath,new URL(t||"/.well-known/openid-configuration",e).toString()),this.adapter.requester);var e,t}))}async#t(e,t){if(!await this.isAuthenticated())throw new De("not_authenticated");const r=$e(e,t),n=this.accessTokenMap.get(r);return n&&n.expiresAt>Date.now()/1e3?n.token:(n&&this.accessTokenMap.delete(r),this.getAccessTokenByRefreshToken(e,t))}async#r(t){if(!this.conversalyseConfig.scopes?.includes(e.UserScope.Organizations))throw new De("missing_scope_organizations");return this.getAccessToken(void 0,t)}async#n(){this.accessTokenMap.clear(),await this.adapter.storage.removeItem("accessToken")}async#s(){await Promise.all([this.setRefreshToken(null),this.setIdToken(null),this.clearAccessToken()])}async getCodeAndStateFromCallbackUri(e){const t=await this.getSignInSession();if(!t)throw new De("sign_in_session.not_found");const{redirectUri:r,postRedirectUri:n,state:s,codeVerifier:o}=t,i=M(e,r,s),a=$e(),{appId:c}=this.conversalyseConfig,{tokenEndpoint:d}=await this.getOidcConfig();return{code:i,redirectUri:r,postRedirectUri:n,state:s,codeVerifier:o,accessTokenKey:a,clientId:c,tokenEndpoint:d,requestedAt:Math.round(Date.now()/1e3)}}async#o(e){const t=await this.getSignInSession();if(!t)throw new De("sign_in_session.not_found");const{redirectUri:r,postRedirectUri:n,state:s,codeVerifier:o}=t,i=M(e,r,s),a=$e(),{appId:c}=this.conversalyseConfig,{tokenEndpoint:d}=await this.getOidcConfig(),h=Math.round(Date.now()/1e3),{idToken:l,refreshToken:p,accessToken:u,scope:f,expiresIn:g}=await(async({clientId:e,tokenEndpoint:t,redirectUri:r,codeVerifier:n,code:s,resource:o},i)=>{const a=new URLSearchParams;return a.append(A.ClientId,e),a.append(A.Code,s),a.append(A.CodeVerifier,n),a.append(A.RedirectUri,r),a.append(A.GrantType,T.AuthorizationCode),o&&a.append(A.Resource,o),S(await i(t,{method:"POST",headers:b.formUrlEncoded,body:a.toString()}))})({clientId:c,tokenEndpoint:d,redirectUri:r,codeVerifier:o,code:i},this.adapter.requester);await this.jwtVerifier.verifyIdToken(l),await this.setRefreshToken(p??null),await this.setIdToken(l),this.accessTokenMap.set(a,{token:u,scope:f,expiresAt:h+g}),await this.saveAccessTokenMap(),await this.setSignInSession(null),n&&await this.adapter.navigate(n,{for:"post-sign-in"})}}const We=e=>async(...t)=>{const r=await e(...t);if(!r.ok){const e=r.clone(),t=await r.json();if(console.error(`ConversalyseAuth requester error: [status=${r.status}]`,t),!j(n=t)||"string"!=typeof n.code||"string"!=typeof n.message)throw new D("unexpected_response_error",t);const{code:s,message:o}=t;throw new $(s,o,e)}var n;return r.json()};class ze extends Me{constructor(e,t,r){super(e,t,r??(e=>new Ue(e)))}}const He="conversalyse_auth_cache";class Le{constructor(e){this.appId=e}getKey(e){return void 0===e?`${He}:${this.appId}`:`${He}:${this.appId}:${e}`}async getItem(e){return sessionStorage.getItem(this.getKey(e))}async setItem(e,t){sessionStorage.setItem(this.getKey(e),t)}async removeItem(e){sessionStorage.removeItem(`${this.getKey(e)}`)}}const Ne="conversalyse_auth";class Ve{constructor(e){this.appId=e}getKey(e){return void 0===e?`${Ne}:${this.appId}`:`${Ne}:${this.appId}:${e}`}async getItem(e){return"undefined"==typeof window?null:"signInSession"===e?sessionStorage.getItem(this.getKey(e))??sessionStorage.getItem(this.getKey()):localStorage.getItem(this.getKey(e))}async setItem(e,t){"undefined"!=typeof window&&("signInSession"!==e?localStorage.setItem(this.getKey(e),t):sessionStorage.setItem(this.getKey(e),t))}async removeItem(e){"undefined"!=typeof window&&("signInSession"!==e?localStorage.removeItem(this.getKey(e)):sessionStorage.removeItem(this.getKey(e)))}}const Fe="function"==typeof btoa,qe="function"==typeof Buffer;"function"==typeof TextDecoder&&new TextDecoder,"function"==typeof TextEncoder&&new TextEncoder;const Ge=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=");(e=>{let t={};e.forEach(((e,r)=>t[e]=r))})(Ge);const Be=String.fromCharCode.bind(String);"function"==typeof Uint8Array.from&&Uint8Array.from.bind(Uint8Array);const Ye=Fe?e=>btoa(e):qe?e=>Buffer.from(e,"binary").toString("base64"):e=>{let t,r,n,s,o="";const i=e.length%3;for(let i=0;i<e.length;){if((r=e.charCodeAt(i++))>255||(n=e.charCodeAt(i++))>255||(s=e.charCodeAt(i++))>255)throw new TypeError("invalid character found");t=r<<16|n<<8|s,o+=Ge[t>>18&63]+Ge[t>>12&63]+Ge[t>>6&63]+Ge[63&t]}return i?o.slice(0,i-3)+"===".substring(i):o},Xe=qe?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let r=0,n=e.length;r<n;r+=4096)t.push(Be.apply(null,e.subarray(r,r+4096)));return Ye(t.join(""))},Qe=(e,t=!1)=>t?Xe(e).replace(/=/g,"").replace(/[+\/]/g,(e=>"+"==e?"-":"_")):Xe(e),Ze=(e=64)=>Qe(crypto.getRandomValues(new Uint8Array(e)),!0),et=()=>Ze(),tt=()=>Ze(),rt=async e=>{if(void 0===crypto.subtle)throw new D("crypto_subtle_unavailable");const t=(new TextEncoder).encode(e),r=new Uint8Array(await crypto.subtle.digest("SHA-256",t));return Qe(r,!0)},nt=e=>{window.location.assign(e)};class st extends ze{constructor(e,t=!1){super(e,{requester:We(fetch),navigate:nt,storage:new Ve(e.appId),unstable_cache:U(t&&new Le(e.appId)),generateCodeChallenge:rt,generateCodeVerifier:tt,generateState:et})}stripQueryParams(e,t={preserveHash:!0}){const{preserveHash:r=!0}=t;if("undefined"==typeof window||!window.history||!history.replaceState)return!1;const n=Array.isArray(e)?e:[e];if(0===n.length)return!1;const s=Object.create(null);for(let e=0;e<n.length;e++)s[n[e]]=!0;if(function(){try{const e=self.URL;if("function"!=typeof e)return!1;const t=new e("http://example.com/?a=1#x");return"function"==typeof t.searchParams?.get}catch{return!1}}())try{const e=new URL(window.location.href),t=e.toString();for(const t of n)e.searchParams.delete(t);r||(e.hash="");const s=e.toString();return s!==t&&(history.replaceState(history.state,document.title,s),!0)}catch{}const o=window.location.search;if(!o||"?"===o){if(!r&&window.location.hash){const e=window.location.pathname;return history.replaceState(history.state,document.title,e),!0}return!1}const i=o.slice(1).split("&"),a=[];for(let e=0;e<i.length;e++){const t=i[e];if(!t)continue;const r=t.indexOf("="),n=-1===r?t:t.slice(0,r);let o;try{o=decodeURIComponent(n.replace(/\+/g," "))}catch{o=n}s[n]||s[o]||a.push(t)}const c=a.length?"?"+a.join("&"):"",d=window.location.pathname+c+(r?window.location.hash:"");return d!==window.location.pathname+window.location.search+window.location.hash&&(history.replaceState(history.state,document.title,d),!0)}}e.BaseClient=ze,e.BrowserStorage=Ve,e.Client=st,e.ConversalyseAuthClientError=De,e.ConversalyseAuthError=D,e.ConversalyseAuthRequestError=$,e.OidcError=J,e.buildOrganizationUrn=e=>`${E}${e}`,e.createRequester=We,e.default=st,e.generateCodeChallenge=rt,e.generateCodeVerifier=tt,e.generateState=et,e.getOrganizationIdFromUrn=e=>{if(!e.startsWith(E))throw new TypeError("Invalid organization URN.");return e.slice(30)},e.isConversalyseAuthRequestError=e=>!!j(e)&&(e instanceof Error&&"ConversalyseAuthRequestError"===e.name),e.organizationUrnPrefix=E,Object.defineProperty(e,"__esModule",{value:!0})}));
