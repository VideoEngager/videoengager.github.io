(function(de,B){typeof exports=="object"&&typeof module<"u"?B(exports):typeof define=="function"&&define.amd?define(["exports"],B):(de=typeof globalThis<"u"?globalThis:de||self,B(de.VideoEngager={}))})(this,function(de){"use strict";var B=typeof Reflect=="object"?Reflect:null,lt=B&&typeof B.apply=="function"?B.apply:function(e,r,i){return Function.prototype.apply.call(e,r,i)},$e;B&&typeof B.ownKeys=="function"?$e=B.ownKeys:Object.getOwnPropertySymbols?$e=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:$e=function(e){return Object.getOwnPropertyNames(e)};function Bt(c){console&&console.warn&&console.warn(c)}var ht=Number.isNaN||function(e){return e!==e};function R(){R.init.call(this)}R.EventEmitter=R,R.prototype._events=void 0,R.prototype._eventsCount=0,R.prototype._maxListeners=void 0;var ft=10;function Fe(c){if(typeof c!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof c)}Object.defineProperty(R,"defaultMaxListeners",{enumerable:!0,get:function(){return ft},set:function(c){if(typeof c!="number"||c<0||ht(c))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+c+".");ft=c}}),R.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},R.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ht(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function gt(c){return c._maxListeners===void 0?R.defaultMaxListeners:c._maxListeners}R.prototype.getMaxListeners=function(){return gt(this)},R.prototype.emit=function(e){for(var r=[],i=1;i<arguments.length;i++)r.push(arguments[i]);var o=e==="error",u=this._events;if(u!==void 0)o=o&&u.error===void 0;else if(!o)return!1;if(o){var d;if(r.length>0&&(d=r[0]),d instanceof Error)throw d;var h=new Error("Unhandled error."+(d?" ("+d.message+")":""));throw h.context=d,h}var S=u[e];if(S===void 0)return!1;if(typeof S=="function")lt(S,this,r);else for(var A=S.length,D=wt(S,A),i=0;i<A;++i)lt(D[i],this,r);return!0};function mt(c,e,r,i){var o,u,d;if(Fe(r),u=c._events,u===void 0?(u=c._events=Object.create(null),c._eventsCount=0):(u.newListener!==void 0&&(c.emit("newListener",e,r.listener?r.listener:r),u=c._events),d=u[e]),d===void 0)d=u[e]=r,++c._eventsCount;else if(typeof d=="function"?d=u[e]=i?[r,d]:[d,r]:i?d.unshift(r):d.push(r),o=gt(c),o>0&&d.length>o&&!d.warned){d.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+d.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=c,h.type=e,h.count=d.length,Bt(h)}return c}R.prototype.addListener=function(e,r){return mt(this,e,r,!1)},R.prototype.on=R.prototype.addListener,R.prototype.prependListener=function(e,r){return mt(this,e,r,!0)};function Yt(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function pt(c,e,r){var i={fired:!1,wrapFn:void 0,target:c,type:e,listener:r},o=Yt.bind(i);return o.listener=r,i.wrapFn=o,o}R.prototype.once=function(e,r){return Fe(r),this.on(e,pt(this,e,r)),this},R.prototype.prependOnceListener=function(e,r){return Fe(r),this.prependListener(e,pt(this,e,r)),this},R.prototype.removeListener=function(e,r){var i,o,u,d,h;if(Fe(r),o=this._events,o===void 0)return this;if(i=o[e],i===void 0)return this;if(i===r||i.listener===r)--this._eventsCount===0?this._events=Object.create(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,i.listener||r));else if(typeof i!="function"){for(u=-1,d=i.length-1;d>=0;d--)if(i[d]===r||i[d].listener===r){h=i[d].listener,u=d;break}if(u<0)return this;u===0?i.shift():Qt(i,u),i.length===1&&(o[e]=i[0]),o.removeListener!==void 0&&this.emit("removeListener",e,h||r)}return this},R.prototype.off=R.prototype.removeListener,R.prototype.removeAllListeners=function(e){var r,i,o;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var u=Object.keys(i),d;for(o=0;o<u.length;++o)d=u[o],d!=="removeListener"&&this.removeAllListeners(d);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(r=i[e],typeof r=="function")this.removeListener(e,r);else if(r!==void 0)for(o=r.length-1;o>=0;o--)this.removeListener(e,r[o]);return this};function vt(c,e,r){var i=c._events;if(i===void 0)return[];var o=i[e];return o===void 0?[]:typeof o=="function"?r?[o.listener||o]:[o]:r?qt(o):wt(o,o.length)}R.prototype.listeners=function(e){return vt(this,e,!0)},R.prototype.rawListeners=function(e){return vt(this,e,!1)},R.listenerCount=function(c,e){return typeof c.listenerCount=="function"?c.listenerCount(e):Et.call(c,e)},R.prototype.listenerCount=Et;function Et(c){var e=this._events;if(e!==void 0){var r=e[c];if(typeof r=="function")return 1;if(r!==void 0)return r.length}return 0}R.prototype.eventNames=function(){return this._eventsCount>0?$e(this._events):[]};function wt(c,e){for(var r=new Array(e),i=0;i<e;++i)r[i]=c[i];return r}function Qt(c,e){for(;e+1<c.length;e++)c[e]=c[e+1];c.pop()}function qt(c){for(var e=new Array(c.length),r=0;r<e.length;++r)e[r]=c[r].listener||c[r];return e}const _e=Object.freeze({active:"active",ended:"ended",idle:"idle"});class Kt{initialize(e){}async Sentry(){this.promise&&await this.promise,console.error("[sentry] Sentry is not initialized. Please call initialize() first.")}captureException(...e){}}const yt=new Kt;let Zt=class{constructor(e=!1,r){this.debugEnabled=!1,this.name="UnknownLogger",this.debugEnabled=e,this.name=r}setLevel(e){this.debugEnabled=e}debug(...e){this.debugEnabled&&console.debug(`[${this.name}]`,...e)}info(...e){this.debugEnabled&&console.info(`[${this.name}]`,...e)}warn(...e){this.debugEnabled&&console.warn(`[${this.name}]`,...e)}error(...e){console.error(`[${this.name}]`,...e)}log(...e){console.log(`[${this.name}]`,...e)}};function Xt(c,e){c.location.href=e}function en(c){c.document.title="VideoEngager";const e=c.document.createElement("div");e.id="loading",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="24px",e.style.color="#000",e.style.fontFamily="Arial, sans-serif",e.style.textAlign="center",e.textContent="Loading ...",c.document.body.appendChild(e),c.document.documentElement.style.margin="0",c.document.documentElement.style.padding="0",c.document.documentElement.style.width="100%",c.document.documentElement.style.height="100vh",c.document.documentElement.style.overflow="hidden",c.document.body.style.margin="0",c.document.body.style.padding="0",c.document.body.style.width="100%",c.document.body.style.height="100%"}function St(c){return!!c&&(c==null?void 0:c.closed)===!1}class It extends Error{constructor(e){super(`Operation "${e}" is already running`),this.op=e}}class bt extends Error{constructor(e,r){super(`Cannot run "${e}" while [${r.join(", ")}] are running`),this.op=e,this.conflicts=r}}class ve extends Error{constructor(e){super(`Operation "${e}" was aborted`),this.op=e}}class He extends Error{constructor(e,r){super(`Operation "${e}" timed out after ${r} ms`),this.op=e,this.ms=r}}const we=class we{constructor(e,r={memoryLeakCheckTimeoutMs:1e4}){this.logger=e,this.configs=r,this.operations=new Map}async run(e,r,i={}){var G,fe,ge,xe,Ne,Se,Ie,me,X,Ue,oe,be,se,We,Ce,ae,x;const{waitIfRunning:o=!1,useExistingRunResult:u=!1,onExistingRunFail:d="ignore",waitIfRunningDelayMs:h=0,conflictsWith:S=[],waitFor:A=[],waitForDelayMs:D=0,timeoutMs:M=0,signal:C,beforeRun:N,onSuccess:F,onAbort:Z,onError:ye,onWaitForRunsFail:Ye="ignore",transformError:Qe}=i;(G=this.logger)==null||G.debug(`Running operation "${e}" with`);const ot=setTimeout(()=>{var g;(g=this.logger)==null||g.warn(`Operation "${e}" is taking too long to complete. Possible memory leak detected.`)},this.configs.memoryLeakCheckTimeoutMs);let he,_;const V=()=>{_&&(clearTimeout(_),_=void 0),C&&he&&(C.removeEventListener("abort",he),he=void 0),clearTimeout(ot)},Y=Qe||(g=>g instanceof Error?g:new Error(String(g)));if(this.isRunning(e))if((fe=this.logger)==null||fe.debug(`"${e}" already running`),o||u){const U=await this.operations.get(e).promise.catch($=>{var H;if(d==="throw")throw V(),$;return(H=this.logger)==null||H.debug(`"${e}" existing operation failed, ignoring error and continuing`),V(),$});if(h>0&&((ge=this.logger)==null||ge.debug(`Adding artificial delay of ${h}ms after waitIfRunning for "${e}"`),await new Promise($=>setTimeout($,h))),u){if(U instanceof Error)throw V(),U;return V(),U}(xe=this.logger)==null||xe.debug(`"${e}" completed, now running new instance`)}else throw V(),(Ne=this.logger)==null||Ne.debug(`"${e}" is already running, not starting a new instance`),Y(new It(e));const ie=S.filter(g=>this.isRunning(g));if(ie.length)throw(Se=this.logger)==null||Se.debug(`"${e}" conflicts with [${ie.join(", ")}]`),V(),Y(new bt(e,ie));const Q=A.filter(g=>this.isRunning(g));Q.length&&((Ie=this.logger)==null||Ie.debug(`"${e}" waiting for [${Q.join(", ")}]`),Ye==="throw"?await Promise.all(Q.map(g=>this.operations.get(g).promise)):await Promise.allSettled(Q.map(g=>this.operations.get(g).promise)),(me=this.logger)==null||me.debug(`"${e}" done waiting for dependencies`),D>0&&((X=this.logger)==null||X.debug(`Adding artificial delay of ${D}ms after waitFor for "${e}"`),await new Promise(g=>setTimeout(g,D))));const J=new AbortController,{signal:v}=J;if(C&&(C.aborted?J.abort():(he=()=>{var g;J.abort(),(g=this.logger)==null||g.debug(`"${e}" aborted by external signal`)},C.addEventListener("abort",he,{once:!0}))),N)try{(Ue=this.logger)==null||Ue.debug(`Executing beforeRun hook for "${e}"`);const g=await N(e,v);if(v.aborted)throw V(),Y(new ve(e));if(g&&g.skip)return(oe=this.logger)==null||oe.debug(`Operation "${e}" silently skipped by beforeRun hook`),V(),g.value}catch(g){if((be=this.logger)==null||be.debug(`beforeRun hook aborted operation "${e}": ${g}`),V(),g instanceof ve)throw Y(g);const U=new Error(`Operation "${e}" aborted by beforeRun hook: ${g}`);throw U.cause=g,Y(U)}const De=(async()=>{var g;try{M>0&&((g=this.logger)==null||g.debug(`Setting timeout of ${M}ms for "${e}"`),_=setTimeout(()=>{var $;($=this.logger)==null||$.debug(`"${e}" timed out after ${M}ms`),J.abort("Timeout")},M));const U=r(v);return await new Promise(($,H)=>{var Oe;(Oe=this.logger)==null||Oe.debug(`"${e}" operation started`),J.signal.addEventListener("abort",pe=>{var ce;(ce=this.logger)==null||ce.debug(`"${e}" aborted by controller with reason: ${v.reason}`),H(v.reason==="Timeout"?new He(e,M):new ve(e))}),U.then($).catch(pe=>{var ce,Ve;v.aborted?((ce=this.logger)==null||ce.debug(`"${e}" operation aborted`),H(new ve(e))):((Ve=this.logger)==null||Ve.debug(`"${e}" operation failed: ${pe}`),H(pe))})})}finally{V()}})();this.operations.set(e,{promise:De,controller:J});try{const g=await De;(se=this.logger)==null||se.debug(`"${e}" operation completed successfully`);try{await(F==null?void 0:F(g))}catch(U){(We=this.logger)==null||We.error(`onSuccess hook for "${e}" failed`,U)}return g}catch(g){if(g instanceof DOMException&&g.name==="AbortError"||g instanceof ve||g instanceof He){const U=g instanceof He?`"${e}" timed out after ${M}ms`:`"${e}" aborted`;(Ce=this.logger)==null||Ce.warn(U);try{await(Z==null?void 0:Z())}catch($){(ae=this.logger)==null||ae.error(`onAbort hook for "${e}" failed`,$)}throw Y(g)}else{try{await(ye==null?void 0:ye(g))}catch(U){(x=this.logger)==null||x.error(`onError hook for "${e}" failed`,U)}throw Y(g)}}finally{this.operations.delete(e)}}isRunning(e){return this.operations.has(e)}getRunningOperations(){return[...this.operations.keys()]}async waitFor(e){const r=this.operations.get(e);r&&await r.promise}async waitForAll(){await Promise.all([...this.operations.values()].map(e=>e.promise))}async waitForMany({operations:e,delay:r=0}){var o;const i=e.filter(u=>this.operations.has(u));if(i.length===0){(o=this.logger)==null||o.debug(`No operations found to wait for: ${e.join(", ")}`);return}await Promise.allSettled(i.map(u=>{var d;return(d=this.operations.get(u))==null?void 0:d.promise})),r>0&&await new Promise(u=>setTimeout(u,r))}abort(e,r="Abort Invoked"){var o,u,d;(o=this.logger)==null||o.debug(`Aborting operation "${e}"`);const i=this.operations.get(e);return i?(i.controller.abort(r),(d=this.logger)==null||d.debug(`Aborted operation "${e}" with reason: ${r}`),!0):((u=this.logger)==null||u.debug(`Operation "${e}" not found`),!1)}abortAll(e="Abort All Invoked"){var i,o;(i=this.logger)==null||i.debug("Aborting all operations");let r=0;for(const[u,d]of this.operations.entries())d.controller.abort(e),r++,(o=this.logger)==null||o.debug(`Aborted operation "${u}"`);return r}};we.OperationRunningError=It,we.ConflictError=bt,we.OperationAbortedError=ve,we.OperationTimeoutError=He;let ze=we;function tn(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var Xe={exports:{}},Je={exports:{}},nn=Je.exports,Ct;function rn(){return Ct||(Ct=1,function(c,e){(function(r,i){c.exports=i()})(typeof self<"u"?self:nn,function(){return function(r){var i={};function o(u){if(i[u])return i[u].exports;var d=i[u]={i:u,l:!1,exports:{}};return r[u].call(d.exports,d,d.exports,o),d.l=!0,d.exports}return o.m=r,o.c=i,o.d=function(u,d,h){o.o(u,d)||Object.defineProperty(u,d,{configurable:!1,enumerable:!0,get:h})},o.n=function(u){var d=u&&u.__esModule?function(){return u.default}:function(){return u};return o.d(d,"a",d),d},o.o=function(u,d){return Object.prototype.hasOwnProperty.call(u,d)},o.p="",o(o.s="./src/index.js")}({"./src/index.js":function(r,i,o){Object.defineProperty(i,"__esModule",{value:!0});var u={};o.d(u,"cleanUpWindow",function(){return zt}),o.d(u,"Promise",function(){return x}),o.d(u,"bridge",function(){return Jt}),o.d(u,"init",function(){return ct}),o.d(u,"parent",function(){return Ht}),o.d(u,"send",function(){return Ae}),o.d(u,"request",function(){return at}),o.d(u,"sendToParent",function(){return jt}),o.d(u,"client",function(){return Gt}),o.d(u,"on",function(){return ke}),o.d(u,"listen",function(){return Ze}),o.d(u,"once",function(){return $t}),o.d(u,"listener",function(){return Ft}),o.d(u,"CONFIG",function(){return G}),o.d(u,"CONSTANTS",function(){return v}),o.d(u,"disable",function(){return _t});function d(t){return Object.prototype.toString.call(t)==="[object RegExp]"}var h={MOCK:"mock:",FILE:"file:",ABOUT:"about:"},S="*",A=`Call was rejected by callee.\r
`;function D(){return(arguments.length>0&&arguments[0]!==void 0?arguments[0]:window).location.protocol===h.ABOUT}function M(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window;if(t)try{if(t.parent&&t.parent!==t)return t.parent}catch{}}function C(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window;if(t&&!M(t))try{return t.opener}catch{}}function N(t){try{return t&&t.location&&t.location.href,!0}catch{}return!1}function F(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window,n=t.location;if(!n)throw new Error("Can not read window location");var s=n.protocol;if(!s)throw new Error("Can not read window protocol");if(s===h.FILE)return h.FILE+"//";if(s===h.ABOUT){var a=M(t);return a&&N(a)?F(a):h.ABOUT+"//"}var l=n.host;if(!l)throw new Error("Can not read window host");return s+"//"+l}function Z(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window,n=F(t);return n&&t.mockDomain&&t.mockDomain.indexOf(h.MOCK)===0?t.mockDomain:n}function ye(t){try{if(t===window)return!0}catch{}try{var n=Object.getOwnPropertyDescriptor(t,"location");if(n&&n.enumerable===!1)return!1}catch{}try{if(D(t)&&N(t))return!0}catch{}try{if(F(t)===F(window))return!0}catch{}return!1}function Ye(t,n){if(!t||!n)return!1;var s=M(n);return s?s===t:function(a){var l=[];try{for(;a.parent!==a;)l.push(a.parent),a=a.parent}catch{}return l}(n).indexOf(t)!==-1}function Qe(t){var n=[],s=void 0;try{s=t.frames}catch{s=t}var a=void 0;try{a=s.length}catch{}if(a===0)return n;if(a){for(var l=0;l<a;l++){var f=void 0;try{f=s[l]}catch{continue}n.push(f)}return n}for(var m=0;m<100;m++){var p=void 0;try{p=s[m]}catch{return n}if(!p)return n;n.push(p)}return n}var ot=[],he=[];function _(t){var n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];try{if(t===window)return!1}catch{return!0}try{if(!t)return!0}catch{return!0}try{if(t.closed)return!0}catch(l){return!l||l.message!==A}if(n&&function(l){if(!ye(l))return!1;try{if(l===window||D(l)&&N(l)||Z(window)===Z(l))return!0}catch{}return!1}(t))try{if(t.mockclosed)return!0}catch{}try{if(!t.parent||!t.top)return!0}catch{}var s=function(l,f){for(var m=0;m<l.length;m++)try{if(l[m]===f)return m}catch{}return-1}(ot,t);if(s!==-1){var a=he[s];if(a&&function(l){if(!l.contentWindow||!l.parentNode)return!0;var f=l.ownerDocument;return!(!f||!f.documentElement||f.documentElement.contains(l))}(a))return!0}return!1}function V(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window;return C(t=t||window)||M(t)||void 0}function re(t,n){if(typeof t=="string"){if(typeof n=="string")return t===S||n===t;if(d(n)||Array.isArray(n))return!1}return d(t)?d(n)?t.toString()===n.toString():!Array.isArray(n)&&!!n.match(t):!!Array.isArray(t)&&(Array.isArray(n)?JSON.stringify(t)===JSON.stringify(n):!d(n)&&t.some(function(s){return re(s,n)}))}function Y(t){try{if(t===window)return!0}catch(n){if(n&&n.message===A)return!0}try{if(Object.prototype.toString.call(t)==="[object Window]")return!0}catch(n){if(n&&n.message===A)return!0}try{if(window.Window&&t instanceof window.Window)return!0}catch(n){if(n&&n.message===A)return!0}try{if(t&&t.self===t)return!0}catch(n){if(n&&n.message===A)return!0}try{if(t&&t.parent===t)return!0}catch(n){if(n&&n.message===A)return!0}try{if(t&&t.top===t)return!0}catch(n){if(n&&n.message===A)return!0}try{if(t&&t.__cross_domain_utils_window_check__==="__unlikely_value__")return!1}catch{return!0}return!1}function ie(t,n){for(var s=0;s<t.length;s++)try{if(t[s]===n)return s}catch{}return-1}var Q,J=function(){function t(){if(function(n,s){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")}(this),this.name="__weakmap_"+(1e9*Math.random()>>>0)+"__",function(){if(typeof WeakMap>"u"||Object.freeze===void 0)return!1;try{var n=new WeakMap,s={};return Object.freeze(s),n.set(s,"__testvalue__"),n.get(s)==="__testvalue__"}catch{return!1}}())try{this.weakmap=new WeakMap}catch{}this.keys=[],this.values=[]}return t.prototype._cleanupClosedWindows=function(){for(var n=this.weakmap,s=this.keys,a=0;a<s.length;a++){var l=s[a];if(Y(l)&&_(l)){if(n)try{n.delete(l)}catch{}s.splice(a,1),this.values.splice(a,1),a-=1}}},t.prototype.isSafeToReadWrite=function(n){if(Y(n))return!1;try{n&&n.self,n&&n[this.name]}catch{return!1}return!0},t.prototype.set=function(n,s){if(!n)throw new Error("WeakMap expected key");var a=this.weakmap;if(a)try{a.set(n,s)}catch{delete this.weakmap}if(this.isSafeToReadWrite(n))try{var l=this.name,f=n[l];f&&f[0]===n?f[1]=s:Object.defineProperty(n,l,{value:[n,s],writable:!0});return}catch{}this._cleanupClosedWindows();var m=this.keys,p=this.values,w=ie(m,n);w===-1?(m.push(n),p.push(s)):p[w]=s},t.prototype.get=function(n){if(!n)throw new Error("WeakMap expected key");var s=this.weakmap;if(s)try{if(s.has(n))return s.get(n)}catch{delete this.weakmap}if(this.isSafeToReadWrite(n))try{var a=n[this.name];return a&&a[0]===n?a[1]:void 0}catch{}this._cleanupClosedWindows();var l=ie(this.keys,n);if(l!==-1)return this.values[l]},t.prototype.delete=function(n){if(!n)throw new Error("WeakMap expected key");var s=this.weakmap;if(s)try{s.delete(n)}catch{delete this.weakmap}if(this.isSafeToReadWrite(n))try{var a=n[this.name];a&&a[0]===n&&(a[0]=a[1]=void 0)}catch{}this._cleanupClosedWindows();var l=this.keys,f=ie(l,n);f!==-1&&(l.splice(f,1),this.values.splice(f,1))},t.prototype.has=function(n){if(!n)throw new Error("WeakMap expected key");var s=this.weakmap;if(s)try{if(s.has(n))return!0}catch{delete this.weakmap}if(this.isSafeToReadWrite(n))try{var a=n[this.name];return!(!a||a[0]!==n)}catch{}return this._cleanupClosedWindows(),ie(this.keys,n)!==-1},t.prototype.getOrSet=function(n,s){if(this.has(n))return this.get(n);var a=s();return this.set(n,a),a},t}(),v={POST_MESSAGE_TYPE:{REQUEST:"postrobot_message_request",RESPONSE:"postrobot_message_response",ACK:"postrobot_message_ack"},POST_MESSAGE_ACK:{SUCCESS:"success",ERROR:"error"},POST_MESSAGE_NAMES:{METHOD:"postrobot_method",HELLO:"postrobot_ready",OPEN_TUNNEL:"postrobot_open_tunnel"},WINDOW_TYPES:{FULLPAGE:"fullpage",POPUP:"popup",IFRAME:"iframe"},WINDOW_PROPS:{POSTROBOT:"__postRobot__"},SERIALIZATION_TYPES:{METHOD:"postrobot_method",ERROR:"postrobot_error",PROMISE:"postrobot_promise",ZALGO_PROMISE:"postrobot_zalgo_promise",REGEX:"regex"},SEND_STRATEGIES:{POST_MESSAGE:"postrobot_post_message",BRIDGE:"postrobot_bridge",GLOBAL:"postrobot_global"},MOCK_PROTOCOL:"mock:",FILE_PROTOCOL:"file:",BRIDGE_NAME_PREFIX:"__postrobot_bridge__",POSTROBOT_PROXY:"__postrobot_proxy__",WILDCARD:"*"},De={METHOD:"postrobot_method",HELLO:"postrobot_hello",OPEN_TUNNEL:"postrobot_open_tunnel"},G=(Object.keys(De).map(function(t){return De[t]}),{ALLOW_POSTMESSAGE_POPUP:!("__ALLOW_POSTMESSAGE_POPUP__"in window)||window.__ALLOW_POSTMESSAGE_POPUP__,BRIDGE_TIMEOUT:5e3,CHILD_WINDOW_TIMEOUT:5e3,ACK_TIMEOUT:window.navigator.userAgent.match(/MSIE/i)!==-1?1e4:2e3,RES_TIMEOUT:-1,ALLOWED_POST_MESSAGE_METHODS:(Q={},Q[v.SEND_STRATEGIES.POST_MESSAGE]=!0,Q[v.SEND_STRATEGIES.BRIDGE]=!0,Q[v.SEND_STRATEGIES.GLOBAL]=!0,Q),ALLOW_SAME_ORIGIN:!1});window.location.href.indexOf(v.FILE_PROTOCOL)===0&&(G.ALLOW_POSTMESSAGE_POPUP=!0);var fe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function ge(t){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;if(n>=3)return"stringifyError stack overflow";try{if(!t)return"<unknown error: "+Object.prototype.toString.call(t)+">";if(typeof t=="string")return t;if(t instanceof Error){var s=t&&t.stack,a=t&&t.message;if(s&&a)return s.indexOf(a)!==-1?s:a+`
`+s;if(s)return s;if(a)return a}return typeof t.toString=="function"?t.toString():Object.prototype.toString.call(t)}catch(l){return"Error while stringifying error: "+ge(l,n+1)}}var xe=function(t){if(!t)return t;var n=!1;return function(){if(!n)return n=!0,t.apply(this,arguments)}};function Ne(){}function Se(){var t="0123456789abcdef";return"xxxxxxxxxx".replace(/./g,function(){return t.charAt(Math.floor(Math.random()*t.length))})}function Ie(t,n){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;if(s>=100)throw new Error("Self-referential object passed, or object contained too many layers");var a=void 0;if((t===void 0?"undefined":fe(t))!=="object"||t===null||Array.isArray(t)){if(!Array.isArray(t))throw new TypeError("Invalid type: "+(t===void 0?"undefined":fe(t)));a=[]}else a={};return function(l,f){Array.isArray(l)?function(m,p){for(var w=0;w<m.length;w++)p(m[w],w)}(l,f):(l===void 0?"undefined":fe(l))==="object"&&l!==null&&function(m,p){for(var w in m)m.hasOwnProperty(w)&&p(m[w],w)}(l,f)}(t,function(l,f){var m=n(l,f);m!==void 0?a[f]=m:(l===void 0?"undefined":fe(l))==="object"&&l!==null?a[f]=Ie(l,n,s+1):a[f]=l}),a}function me(t){return Object.prototype.toString.call(t)==="[object RegExp]"}function X(t){try{if(!t)return!1;if(typeof Promise<"u"&&t instanceof Promise)return!0;if(typeof window<"u"&&typeof window.Window=="function"&&t instanceof window.Window||typeof window<"u"&&typeof window.constructor=="function"&&t instanceof window.constructor)return!1;var n={}.toString;if(n){var s=n.call(t);if(s==="[object Window]"||s==="[object global]"||s==="[object DOMWindow]")return!1}if(typeof t.then=="function")return!0}catch{return!1}return!1}var Ue=[],oe=[],be=0,se=void 0;function We(){if(!be&&se){var t=se;se=null,t.resolve()}}function Ce(){be+=1}function ae(){be-=1,We()}var x=function(){function t(n){var s=this;if(function(w,I){if(!(w instanceof t))throw new TypeError("Cannot call a class as a function")}(this),this.resolved=!1,this.rejected=!1,this.errorHandled=!1,this.handlers=[],n){var a=void 0,l=void 0,f=!1,m=!1,p=!1;Ce();try{n(function(w){p?s.resolve(w):(f=!0,a=w)},function(w){p?s.reject(w):(m=!0,l=w)})}catch(w){ae(),this.reject(w);return}ae(),p=!0,f?this.resolve(a):m&&this.reject(l)}}return t.prototype.resolve=function(n){if(this.resolved||this.rejected)return this;if(X(n))throw new Error("Can not resolve promise with another promise");return this.resolved=!0,this.value=n,this.dispatch(),this},t.prototype.reject=function(n){var s=this;if(this.resolved||this.rejected)return this;if(X(n))throw new Error("Can not reject promise with another promise");if(!n){var a=n&&typeof n.toString=="function"?n.toString():Object.prototype.toString.call(n);n=new Error("Expected reject to be called with Error, got "+a)}return this.rejected=!0,this.error=n,this.errorHandled||setTimeout(function(){s.errorHandled||function(l,f){if(Ue.indexOf(l)===-1){Ue.push(l),setTimeout(function(){throw l},1);for(var m=0;m<oe.length;m++)oe[m](l,f)}}(n,s)},1),this.dispatch(),this},t.prototype.asyncReject=function(n){return this.errorHandled=!0,this.reject(n),this},t.prototype.dispatch=function(){var n=this.dispatching,s=this.resolved,a=this.rejected,l=this.handlers;if(!n&&(s||a)){this.dispatching=!0,Ce();for(var f=function(b,O){return b.then(function(L){O.resolve(L)},function(L){O.reject(L)})},m=0;m<l.length;m++){var p=l[m],w=p.onSuccess,I=p.onError,y=p.promise,E=void 0;if(s)try{E=w?w(this.value):this.value}catch(b){y.reject(b);continue}else if(a){if(!I){y.reject(this.error);continue}try{E=I(this.error)}catch(b){y.reject(b);continue}}E instanceof t&&(E.resolved||E.rejected)?(E.resolved?y.resolve(E.value):y.reject(E.error),E.errorHandled=!0):X(E)?E instanceof t&&(E.resolved||E.rejected)?E.resolved?y.resolve(E.value):y.reject(E.error):f(E,y):y.resolve(E)}l.length=0,this.dispatching=!1,ae()}},t.prototype.then=function(n,s){if(n&&typeof n!="function"&&!n.call)throw new Error("Promise.then expected a function for success handler");if(s&&typeof s!="function"&&!s.call)throw new Error("Promise.then expected a function for error handler");var a=new t;return this.handlers.push({promise:a,onSuccess:n,onError:s}),this.errorHandled=!0,this.dispatch(),a},t.prototype.catch=function(n){return this.then(void 0,n)},t.prototype.finally=function(n){if(n&&typeof n!="function"&&!n.call)throw new Error("Promise.finally expected a function");return this.then(function(s){return t.try(n).then(function(){return s})},function(s){return t.try(n).then(function(){throw s})})},t.prototype.timeout=function(n,s){var a=this;if(this.resolved||this.rejected)return this;var l=setTimeout(function(){a.resolved||a.rejected||a.reject(s||new Error("Promise timed out after "+n+"ms"))},n);return this.then(function(f){return clearTimeout(l),f})},t.prototype.toPromise=function(){if(typeof Promise>"u")throw new TypeError("Could not find Promise");return Promise.resolve(this)},t.resolve=function(n){return n instanceof t?n:X(n)?new t(function(s,a){return n.then(s,a)}):new t().resolve(n)},t.reject=function(n){return new t().reject(n)},t.asyncReject=function(n){return new t().asyncReject(n)},t.all=function(n){var s=new t,a=n.length,l=[];if(!a)return s.resolve(l),s;for(var f=function(w,I,y){return I.then(function(E){l[w]=E,(a-=1)==0&&s.resolve(l)},function(E){y.reject(E)})},m=0;m<n.length;m++){var p=n[m];if(p instanceof t){if(p.resolved){l[m]=p.value,a-=1;continue}}else if(!X(p)){l[m]=p,a-=1;continue}f(m,t.resolve(p),s)}return a===0&&s.resolve(l),s},t.hash=function(n){var s={};return t.all(Object.keys(n).map(function(a){return t.resolve(n[a]).then(function(l){s[a]=l})})).then(function(){return s})},t.map=function(n,s){return t.all(n.map(s))},t.onPossiblyUnhandledException=function(n){return function(s){return oe.push(s),{cancel:function(){oe.splice(oe.indexOf(s),1)}}}(n)},t.try=function(n,s,a){if(n&&typeof n!="function"&&!n.call)throw new Error("Promise.try expected a function");var l=void 0;Ce();try{l=n.apply(s,a||[])}catch(f){return ae(),t.reject(f)}return ae(),t.resolve(l)},t.delay=function(n){return new t(function(s){setTimeout(s,n)})},t.isPromise=function(n){return!!(n&&n instanceof t)||X(n)},t.flush=function(){return function(n){var s=se=se||new t;return We(),s}()},t}(),g=window[v.WINDOW_PROPS.POSTROBOT]=window[v.WINDOW_PROPS.POSTROBOT]||{};g.registerSelf=function(){};var U=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};g.methods=g.methods||new J;var $=xe(function(){g.on(v.POST_MESSAGE_NAMES.METHOD,{origin:v.WILDCARD},function(t){var n=t.source,s=t.origin,a=t.data,l=g.methods.get(n);if(!l)throw new Error("Could not find any methods this window has privileges to call");var f=l[a.id];if(!f)throw new Error("Could not find method with id: "+a.id);if(!re(f.domain,s))throw new Error("Method domain "+f.domain+" does not match origin "+s);return x.try(function(){return f.method.apply({source:n,origin:s,data:a},a.args)}).then(function(m){return{result:m,id:a.id,name:a.name}})})});function H(t,n){return(t===void 0?"undefined":U(t))==="object"&&t!==null&&t.__type__===n}function Oe(t,n,s,a){var l=Se(),f=g.methods.get(t);return f||(f={},g.methods.set(t,f)),f[l]={domain:n,method:s},{__type__:v.SERIALIZATION_TYPES.METHOD,__id__:l,__name__:a}}function pe(t,n,s){function a(){var l=Array.prototype.slice.call(arguments);return g.send(t,v.POST_MESSAGE_NAMES.METHOD,{id:s.__id__,name:s.__name__,args:l},{domain:n,timeout:-1}).then(function(f){return f.data.result},function(f){throw f})}return a.__name__=s.__name__,a.__xdomain__=!0,a.source=t,a.origin=n,a}function ce(t,n,s){return new x(function(a,l){return pe(t,n,s.__then__)(a,l)})}g.readyPromises=g.readyPromises||new J;function Ve(t){return g.send(t,v.POST_MESSAGE_NAMES.HELLO,{},{domain:v.WILDCARD,timeout:-1}).then(function(n){return{origin:n.origin}})}var st={};st[v.SEND_STRATEGIES.POST_MESSAGE]=function(t,n,s){(Array.isArray(s)?s:typeof s=="string"?[s]:[v.WILDCARD]).map(function(a){if(a.indexOf(v.MOCK_PROTOCOL)===0){if(window.location.protocol===v.FILE_PROTOCOL)return v.WILDCARD;if(!ye(t))throw new Error("Attempting to send messsage to mock domain "+a+", but window is actually cross-domain");return F(t)}return a.indexOf(v.FILE_PROTOCOL)===0?v.WILDCARD:a}).forEach(function(a){return t.postMessage(n,a)})};var wn=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(t[a]=s[a])}return t};function Pt(t,n,s){return x.try(function(){var a;if(n=function(m,p){var w=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},I=Se(),y=function(){var b=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window;return!!C(b)}()?v.WINDOW_TYPES.POPUP:function(){var b=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window;return!!M(b)}()?v.WINDOW_TYPES.IFRAME:v.WINDOW_TYPES.FULLPAGE,E=Z(window);return wn({},p,w,{sourceDomain:E,id:p.id||I,windowType:y})}(t,n,{data:function(m,p,w){return Ie({obj:n.data},function(I,y){return typeof I=="function"?Oe(m,p,I,y.toString()):I instanceof Error?(E=I,{__type__:v.SERIALIZATION_TYPES.ERROR,__message__:ge(E),__code__:E.code}):window.Promise&&I instanceof window.Promise?function(O,L,k,P){return{__type__:v.SERIALIZATION_TYPES.PROMISE,__then__:Oe(O,L,function(j,W){return k.then(j,W)},P+".then")}}(m,p,I,y.toString()):x.isPromise(I)?function(O,L,k,P){return{__type__:v.SERIALIZATION_TYPES.ZALGO_PROMISE,__then__:Oe(O,L,function(j,W){return k.then(j,W)},P+".then")}}(m,p,I,y.toString()):me(I)?(b=I,{__type__:v.SERIALIZATION_TYPES.REGEX,__source__:b.source}):void 0;var E,b}).obj}(t,s),domain:s}),t===window&&!G.ALLOW_SAME_ORIGIN)throw new Error("Attemping to send message to self");if(_(t))throw new Error("Window is closed");var l=[],f=function(m,p,w){var I=void 0,y=void 0;try{if(JSON.stringify({})!=="{}"&&(I=Object.prototype.toJSON,delete Object.prototype.toJSON),JSON.stringify({})!=="{}")throw new Error("Can not correctly serialize JSON objects");if(JSON.stringify([])!=="[]"&&(y=Array.prototype.toJSON,delete Array.prototype.toJSON),JSON.stringify([])!=="[]")throw new Error("Can not correctly serialize JSON objects")}catch(b){throw new Error("Can not repair JSON.stringify: "+b.message)}var E=JSON.stringify.call(this,m,null,2);try{I&&(Object.prototype.toJSON=I),y&&(Array.prototype.toJSON=y)}catch(b){throw new Error("Can not repair JSON.stringify: "+b.message)}return E}(((a={})[v.WINDOW_PROPS.POSTROBOT]=n,a));return x.map(Object.keys(st),function(m){return x.try(function(){if(!G.ALLOWED_POST_MESSAGE_METHODS[m])throw new Error("Strategy disallowed: "+m);return st[m](t,f,s)}).then(function(){return l.push(m+": success"),!0},function(p){return l.push(m+": "+ge(p)+`
`),!1})}).then(function(m){var p=m.some(Boolean),w=n.type+" "+n.name+" "+(p?"success":"error")+`:
  - `+l.join(`
  - `)+`
`;if(!p)throw new Error(w)})})}g.responseListeners=g.responseListeners||{},g.requestListeners=g.requestListeners||{},g.WINDOW_WILDCARD=g.WINDOW_WILDCARD||new function(){},g.erroredResponseListeners=g.erroredResponseListeners||{};var qe,Ke="__domain_regex__";function Lt(t){return g.responseListeners[t]}function Dt(t){delete g.responseListeners[t]}function xt(t){return!!g.erroredResponseListeners[t]}function Nt(t){var n=t.name,s=t.win,a=t.domain;if(s===v.WILDCARD&&(s=null),a===v.WILDCARD&&(a=null),!n)throw new Error("Name required to get request listener");var l=g.requestListeners[n];if(l)for(var f=0,m=[s,g.WINDOW_WILDCARD],p=m==null?0:m.length;f<p;f++){var w=m[f],I=w&&l.get(w);if(I){if(a&&typeof a=="string"){if(I[a])return I[a];if(I[Ke])for(var y=0,E=I[Ke],b=E==null?0:E.length;y<b;y++){var O=E[y],L=O.regex,k=O.listener;if(re(L,a))return k}}if(I[v.WILDCARD])return I[v.WILDCARD]}}}var yn=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(t[a]=s[a])}return t},Ut=((qe={})[v.POST_MESSAGE_TYPE.ACK]=function(t,n,s){if(!xt(s.hash)){var a=Lt(s.hash);if(!a)throw new Error("No handler found for post message ack for message: "+s.name+" from "+n+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!re(a.domain,n))throw new Error("Ack origin "+n+" does not match domain "+a.domain.toString());a.ack=!0}},qe[v.POST_MESSAGE_TYPE.REQUEST]=function(t,n,s){var a=Nt({name:s.name,win:t,domain:n});function l(f){return s.fireAndForget||_(t)?x.resolve():Pt(t,yn({target:s.originalSource,hash:s.hash,name:s.name},f),n)}return x.all([l({type:v.POST_MESSAGE_TYPE.ACK}),x.try(function(){if(!a)throw new Error("No handler found for post message: "+s.name+" from "+n+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!re(a.domain,n))throw new Error("Request origin "+n+" does not match domain "+a.domain.toString());var f=s.data;return a.handler({source:t,origin:n,data:f})}).then(function(f){return l({type:v.POST_MESSAGE_TYPE.RESPONSE,ack:v.POST_MESSAGE_ACK.SUCCESS,data:f})},function(f){var m=ge(f).replace(/^Error: /,""),p=f.code;return l({type:v.POST_MESSAGE_TYPE.RESPONSE,ack:v.POST_MESSAGE_ACK.ERROR,error:m,code:p})})]).then(Ne).catch(function(f){if(a&&a.handleError)return a.handleError(f);throw f})},qe[v.POST_MESSAGE_TYPE.RESPONSE]=function(t,n,s){if(!xt(s.hash)){var a,l=Lt(s.hash);if(!l)throw new Error("No handler found for post message response for message: "+s.name+" from "+n+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!re(l.domain,n))throw new Error("Response origin "+n+" does not match domain "+(a=l.domain,Array.isArray(a)?"("+a.join(" | ")+")":d(a)?"RegExp("+a.toString():a.toString()));if(Dt(s.hash),s.ack===v.POST_MESSAGE_ACK.ERROR){var f=new Error(s.error);return s.code&&(f.code=s.code),l.respond(f,null)}if(s.ack===v.POST_MESSAGE_ACK.SUCCESS){var m=s.data||s.response;return l.respond(null,{source:t,origin:n,data:m})}}},qe),Wt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};g.receivedMessages=g.receivedMessages||[];function Vt(t){if(window&&!window.closed){try{if(!t.source)return}catch{return}var n=t.source,s=t.origin,a=function(l){var f,m=void 0;try{m=(f=l,JSON.parse(f))}catch{return}if(m&&(m===void 0?"undefined":Wt(m))==="object"&&m!==null&&(m=m[v.WINDOW_PROPS.POSTROBOT])&&(m===void 0?"undefined":Wt(m))==="object"&&m!==null&&m.type&&typeof m.type=="string"&&Ut[m.type])return m}(t.data);if(a){if(!a.sourceDomain||typeof a.sourceDomain!="string")throw new Error("Expected message to have sourceDomain");a.sourceDomain.indexOf(v.MOCK_PROTOCOL)!==0&&a.sourceDomain.indexOf(v.FILE_PROTOCOL)!==0||(s=a.sourceDomain),g.receivedMessages.indexOf(a.id)===-1&&(g.receivedMessages.push(a.id),(!_(n)||a.fireAndForget)&&(a.data&&(a.data=function(l,f,m){return Ie({obj:a.data},function(p){if((p===void 0?"undefined":U(p))==="object"&&p!==null)return H(p,v.SERIALIZATION_TYPES.METHOD)?pe(l,f,p):H(p,v.SERIALIZATION_TYPES.ERROR)?function(w,I,y){var E=new Error(y.__message__);return y.__code__&&(E.code=y.__code__),E}(0,0,p):H(p,v.SERIALIZATION_TYPES.PROMISE)?function(w,I,y){return window.Promise?new window.Promise(function(E,b){return pe(w,I,y.__then__)(E,b)}):ce(w,I,y)}(l,f,p):H(p,v.SERIALIZATION_TYPES.ZALGO_PROMISE)?ce(l,f,p):H(p,v.SERIALIZATION_TYPES.REGEX)?function(w,I,y){return new RegExp(y.__source__)}(0,0,p):void 0}).obj}(n,s)),Ut[a.type](n,s,a)))}}}function kt(t){try{t.source}catch{return}Vt({source:t.source||t.sourceElement,origin:t.origin||t.originalEvent&&t.originalEvent.origin,data:t.data})}g.receiveMessage=Vt,g.requestPromises=g.requestPromises||new J;function at(t){return x.try(function(){if(!t.name)throw new Error("Expected options.name");var n=t.name,s=void 0,a=void 0;if(typeof t.window=="string"){var l=document.getElementById(t.window);if(!l)throw new Error("Expected options.window "+Object.prototype.toString.call(t.window)+" to be a valid element id");if(l.tagName.toLowerCase()!=="iframe")throw new Error("Expected options.window "+Object.prototype.toString.call(t.window)+" to be an iframe");if(!l.contentWindow)throw new Error("Iframe must have contentWindow.  Make sure it has a src attribute and is in the DOM.");s=l.contentWindow}else if(t.window instanceof HTMLIFrameElement){if(t.window.tagName.toLowerCase()!=="iframe")throw new Error("Expected options.window "+Object.prototype.toString.call(t.window)+" to be an iframe");if(t.window&&!t.window.contentWindow)throw new Error("Iframe must have contentWindow.  Make sure it has a src attribute and is in the DOM.");t.window&&t.window.contentWindow&&(s=t.window.contentWindow)}else s=t.window;if(!s)throw new Error("Expected options.window to be a window object, iframe, or iframe element id.");var f=s;a=t.domain||v.WILDCARD;var m=t.name+"_"+Se();if(_(f))throw new Error("Target window is closed");var p=!1,w=g.requestPromises.get(f);w||(w=[],g.requestPromises.set(f,w));var I=x.try(function(){if(function(y,E){var b=V(E);if(b)return b===y;if(E===y||function(){var P=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window;try{if(P.top)return P.top}catch{}if(M(P)===P)return P;try{if(Ye(window,P)&&window.top)return window.top}catch{}try{if(Ye(P,window)&&window.top)return window.top}catch{}for(var j=0,W=function te(ut){for(var je=[],Ge=0,Re=Qe(ut),ue=Re==null?0:Re.length;Ge<ue;Ge++){var z=Re[Ge];je.push(z);for(var Te=0,K=te(z),Me=K==null?0:K.length;Te<Me;Te++){var ne=K[Te];je.push(ne)}}return je}(P),q=W==null?0:W.length;j<q;j++){var ee=W[j];try{if(ee.top)return ee.top}catch{}if(M(ee)===ee)return ee}}(E)===E)return!1;for(var O=0,L=Qe(y),k=L==null?0:L.length;O<k;O++)if(L[O]===E)return!0;return!1}(window,f))return function(y){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,b=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"Window",O=g.readyPromises.get(y);return O||(O=new x,g.readyPromises.set(y,O),E!==-1&&setTimeout(function(){return O.reject(new Error(b+" did not load after "+E+"ms"))},E),O)}(f,t.timeout||G.CHILD_WINDOW_TIMEOUT)}).then(function(){var y=(arguments.length>0&&arguments[0]!==void 0?arguments[0]:{}).origin;if(me(a)&&!y)return Ve(f)}).then(function(){var y=(arguments.length>0&&arguments[0]!==void 0?arguments[0]:{}).origin;if(me(a)){if(!re(a,y))throw new Error("Remote window domain "+y+" does not match regex: "+a.toString());a=y}if(typeof a!="string"&&!Array.isArray(a))throw new TypeError("Expected domain to be a string or array");var E=a;return new x(function(b,O){var L=void 0;if(t.fireAndForget||function(W,q){g.responseListeners[W]=q}(m,L={name:n,window:f,domain:E,respond:function(W,q){W||(p=!0,w.splice(w.indexOf(I,1))),W?O(W):b(q)}}),Pt(f,{type:v.POST_MESSAGE_TYPE.REQUEST,hash:m,name:n,data:t.data,fireAndForget:t.fireAndForget},E).catch(O),t.fireAndForget)return b();var k=G.ACK_TIMEOUT,P=t.timeout||G.RES_TIMEOUT,j=100;setTimeout(function W(){if(!p){if(_(f))return L.ack?O(new Error("Window closed for "+n+" before response")):O(new Error("Window closed for "+n+" before ack"));if(k=Math.max(k-j,0),P!==-1&&(P=Math.max(P-j,0)),L.ack){if(P===-1)return;j=Math.min(P,2e3)}else{if(k===0)return O(new Error("No ack for postMessage "+n+" in "+Z()+" in "+G.ACK_TIMEOUT+"ms"));if(P===0)return O(new Error("No response for postMessage "+n+" in "+Z()+" in "+(t.timeout||G.RES_TIMEOUT)+"ms"))}setTimeout(W,j)}},j)})});return I.catch(function(){(function(y){g.erroredResponseListeners[y]=!0})(m),Dt(m)}),w.push(I),I})}function Ae(t,n,s,a){return(a=a||{}).window=t,a.name=n,a.data=s,at(a)}function jt(t,n,s){var a=V();return a?Ae(a,t,n,s):new x(function(l,f){return f(new Error("Window does not have a parent"))})}function Gt(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!t.window)throw new Error("Expected options.window");var n=t.window;return{send:function(s,a){return Ae(n,s,a,t)}}}g.send=Ae;var Sn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function Ze(t){if(!t.name)throw new Error("Expected options.name");if(!t.handler)throw new Error("Expected options.handler");var n=t.name,s=t.window,a=t.domain,l={handler:t.handler,handleError:t.errorHandler||function(w){throw w},window:s,domain:a||v.WILDCARD,name:n},f=function w(I,y){var E=I.name,b=I.win,O=I.domain;if(!E||typeof E!="string")throw new Error("Name required to add request listener");if(Array.isArray(b)){for(var L=[],k=0,P=b,j=P==null?0:P.length;k<j;k++){var W=P[k];L.push(w({name:E,domain:O,win:W},y))}return{cancel:function(){for(var ne=0,dt=L==null?0:L.length;ne<dt;ne++)L[ne].cancel()}}}if(Array.isArray(O)){for(var q=[],ee=0,te=O,ut=te==null?0:te.length;ee<ut;ee++){var je=te[ee];q.push(w({name:E,win:b,domain:je},y))}return{cancel:function(){for(var ne=0,dt=q==null?0:q.length;ne<dt;ne++)q[ne].cancel()}}}var Ge=Nt({name:E,win:b,domain:O});if(b&&b!==v.WILDCARD||(b=g.WINDOW_WILDCARD),O=O||v.WILDCARD,Ge)throw b&&O?new Error("Request listener already exists for "+E+" on domain "+O.toString()+" for "+(b===g.WINDOW_WILDCARD?"wildcard":"specified")+" window"):b?new Error("Request listener already exists for "+E+" for "+(b===g.WINDOW_WILDCARD?"wildcard":"specified")+" window"):O?new Error("Request listener already exists for "+E+" on domain "+O.toString()):new Error("Request listener already exists for "+E);var Re=g.requestListeners,ue=Re[E];ue||(ue=new J,Re[E]=ue);var z=ue.get(b);z||(z={},ue.set(b,z));var Te=O.toString(),K=z[Ke],Me=void 0;return me(O)?(K||(K=[],z[Ke]=K),Me={regex:O,listener:y},K.push(Me)):z[Te]=y,{cancel:function(){z&&(delete z[Te],b&&Object.keys(z).length===0&&ue.delete(b),Me&&K.splice(K.indexOf(Me,1)))}}}({name:n,win:s,domain:a},l);if(t.once){var m=l.handler;l.handler=xe(function(){return f.cancel(),m.apply(this,arguments)})}if(l.window&&t.errorOnClose)var p=function(w,I){var y=void 0;return y=setTimeout(function E(){y=setTimeout(E,50),(function(){s&&(s===void 0?"undefined":Sn(s))==="object"&&_(s)&&(p.cancel(),l.handleError(new Error("Post message target window is closed")))}).call()},50),{cancel:function(){clearTimeout(y)}}}();return{cancel:function(){f.cancel()}}}function ke(t,n,s){return typeof n=="function"&&(s=n,n={}),(n=n||{}).name=t,n.handler=s||n.handler,Ze(n)}function $t(t){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments[2];typeof n=="function"&&(s=n,n={}),n=n||{},s=s||n.handler;var a=n.errorHandler,l=new x(function(m,p){(n=n||{}).name=t,n.once=!0,n.handler=function(w){if(m(w),s)return s(w)},n.errorHandler=function(w){if(p(w),a)return a(w)}}),f=Ze(n);return l.cancel=f.cancel,l}function Ft(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return{on:function(n,s){return ke(n,t,s)}}}g.on=ke;function _t(){delete window[v.WINDOW_PROPS.POSTROBOT],window.removeEventListener("message",kt)}var Ht=V();function zt(t){var n=g.requestPromises.get(t);if(n)for(var s=0,a=n==null?0:n.length;s<a;s++)n[s].reject(new Error("No response from window - cleaned up"));g.popupWindowsByWin&&g.popupWindowsByWin.delete(t),g.remoteWindows&&g.remoteWindows.delete(t),g.requestPromises.delete(t),g.methods.delete(t),g.readyPromises.delete(t)}var Jt=null;function ct(){g.initialized||(n=kt,(t=window).addEventListener?t.addEventListener("message",n):t.attachEvent("onmessage",n),function(){s=function(l){var f=l.source,m=l.origin,p=g.readyPromises.get(f)||new x;p.resolve({origin:m}),g.readyPromises.set(f,p)},g.on(v.POST_MESSAGE_NAMES.HELLO,{domain:v.WILDCARD},function(l){var f=l.source,m=l.origin;return s({source:f,origin:m})});var s,a=V();a&&Ve(a).catch(Ne)}(),$({on:ke,send:Ae}));var t,n;g.initialized=!0}ct(),o.d(i,"cleanUpWindow",function(){return zt}),o.d(i,"Promise",function(){return x}),o.d(i,"bridge",function(){return Jt}),o.d(i,"init",function(){return ct}),o.d(i,"parent",function(){return Ht}),o.d(i,"send",function(){return Ae}),o.d(i,"request",function(){return at}),o.d(i,"sendToParent",function(){return jt}),o.d(i,"client",function(){return Gt}),o.d(i,"on",function(){return ke}),o.d(i,"listen",function(){return Ze}),o.d(i,"once",function(){return $t}),o.d(i,"listener",function(){return Ft}),o.d(i,"CONFIG",function(){return G}),o.d(i,"CONSTANTS",function(){return v}),o.d(i,"disable",function(){return _t}),i.default=u}})})}(Je)),Je.exports}var Ot;function on(){return Ot||(Ot=1,function(c){c.exports=rn(),c.exports.default=c.exports}(Xe)),Xe.exports}var sn=on();const et=tn(sn),le=class le{constructor(e){this.eventEmitter=new R,this.on=this.eventEmitter.on.bind(this.eventEmitter),this.off=this.eventEmitter.off.bind(this.eventEmitter),this.once=this.eventEmitter.once.bind(this.eventEmitter),this.removeListener=this.eventEmitter.removeListener.bind(this.eventEmitter),this.veCurrentVideoCallState=le.getDefaultVideoCallState(),this.customAttributes={},this.veConnectionConfigs={veEnv:"videome.leadsecure.com",veHttps:!0},this.popupInstance=null,this.settingContactCenterIntegration=!1,this.enableVeIframeCommands=!1,this.availableMethods={},this.currentVeIframeState={},this.logger=new Zt(!0,"VideoEngagerWidgetCore"),this.promiseManager=new ze(this.logger),this.veConnectionConfigs=e,typeof this.veConnectionConfigs.veHttps!="boolean"&&(this.veConnectionConfigs.veHttps=!0),this.enableVeIframeCommands=!!e.enableVeIframeCommands,this.registerWindowListeners(),this.registerContactCenterEvents(),yt.initialize(`https://${this.veConnectionConfigs.veEnv}`),this.registerPostRobotGlobalListeners()}get activeInteractionId(){return this.veCurrentVideoCallState.interactionId||null}setVideoCallConfigs(e){if(this.logger.debug("setVideoCallConfigs called",e),this.isCallOngoing)throw this.logger.error("Cannot change configs while in a call"),new Error("Cannot change configs while in a call");const r=le.getDefaultVideoCallState();this.veCurrentVideoCallState=Object.assign({},r,e),this.logger.debug("Video call configs set",this.veCurrentVideoCallState),this.eventEmitter.emit("videoEngager:videoConfig-changed",this.veCurrentVideoCallState)}async setCustomAttributes(e){var i,o,u;const r=Object.assign({},this.customAttributes,e);if(!this.contactCenterIntegrationInstance){this.customAttributes=r,this.logger.debug("Custom attributes set",r),this.eventEmitter.emit("videoEngager:custom-attributes-changed",r);return}if(this.contactCenterIntegrationInstance.inActiveConversation&&(!this.contactCenterIntegrationInstance.capabilities.supportsMidConversationAttributeUpdates||!((i=this.contactCenterIntegrationInstance)!=null&&i.updateCustomAttributes)))throw new Error("Cannot update custom attributes mid-conversation, contact center integration does not support it");this.contactCenterIntegrationInstance.inActiveConversation?(this.logger.debug("Updating custom attributes in contact center",r),await((o=this.contactCenterIntegrationInstance)==null?void 0:o.updateCustomAttributes(r))):(this.logger.debug("Setting custom attributes in contact center",r),await((u=this.contactCenterIntegrationInstance)==null?void 0:u.setCustomAttributes(r))),this.customAttributes=r,this.logger.debug("Custom attributes set",r),this.eventEmitter.emit("videoEngager:custom-attributes-changed",r)}setUiCallbacks(e){if(!e)throw new Error("uiCallbacks parameter is required");this.uiCallbacks=e}async setContactCenterIntegration(e){var r;if(this.settingContactCenterIntegration){this.logger.error("already setting contact center integration");return}if(this.settingContactCenterIntegration=!0,this.contactCenterIntegrationInstance)throw this.settingContactCenterIntegration=!1,new Error("Contact center integration instance already set, create new VideoEngagerWidgetCore instance for a new integration");this.contactCenterIntegrationInstance=e,this.contactCenterIntegrationInstance.setEventEmitter(this.eventEmitter),await((r=this.contactCenterIntegrationInstance)==null?void 0:r.init(this.veConnectionConfigs,this.veCurrentVideoCallState)),this.settingContactCenterIntegration=!1}setVeCallState(e){this.veCurrentVideoCallState.callState!==e&&(this.veCurrentVideoCallState.callState=e,this.logger.debug("Video call state changed",e),this.eventEmitter.emit("videoEngager:call-state-changed",e))}checkIfMessageFromVeInstance(e){return e.source!==this.currentVeInstanceWindow?(this.logger.warn("Message from unknown source",e.source instanceof Window,e.data),!1):(this.logger.debug("Message from VideoEngager instance",e.source instanceof Window,e.data),!0)}registerWindowListeners(){window.addEventListener("message",async e=>{if(e.data.type==="popupClosed"){if(!this.checkIfMessageFromVeInstance(e))return;this.logger.log("popupClosed"),this.eventEmitter.emit("videoEngager:PopupClosed"),this.closeVideoEngagerInstance()}if(e.data.type==="callEnded"){if(!this.checkIfMessageFromVeInstance(e))return;this.logger.log("callEnded"),this.eventEmitter.emit("videoEngager:CallEnded"),this.setVeCallState(_e.ended)}if(e.data.type==="CallStarted"){if(!this.checkIfMessageFromVeInstance(e))return;this.logger.log("CallStarted"),this.eventEmitter.emit("videoEngager:CallStarted"),this.setVeCallState(_e.active)}})}showWidget(){var e;this.setIframeVisibility(!0),(e=this.popupInstance)==null||e.focus()}hideWidget(){this.setIframeVisibility(!1)}postMessageToVeInstance(e){const r=this.currentVeInstanceWindow;if(!r||!this.isCurrentVeInstanceActive)throw new Error("No active VideoEngager instance found");r.postMessage(e,"*")}get currentVeInstanceWindow(){return this.veCurrentVideoCallState.isPopup?this.popupInstance:this.getIframeInstance()}setShouldHaveActiveInstance(e){e!==this.veCurrentVideoCallState.shouldHaveActiveInstance&&(this.logger.debug("Setting shouldHaveActiveInstance",e),this.veCurrentVideoCallState.shouldHaveActiveInstance=e,this.eventEmitter.emit("videoEngager:active-ve-instance",e))}get isCurrentVeInstanceActive(){var e;return this.veCurrentVideoCallState.shouldHaveActiveInstance?this.veCurrentVideoCallState.isPopup?((e=this.popupInstance)==null?void 0:e.closed)===!1:this.getIframeInstance():!1}get isCallOngoing(){return!!this.isCurrentVeInstanceActive}prepareVideoCall(){return this.veCurrentVideoCallState.interactionId?this.logger.debug("Using existing interaction ID",this.veCurrentVideoCallState.interactionId):(this.veCurrentVideoCallState.interactionId=an(),this.logger.debug("Generated new interaction ID",this.veCurrentVideoCallState.interactionId)),this.veCurrentVideoCallState.interactionId}registerContactCenterEvents(){this.eventEmitter.on("integration:sessionEnded",e=>{if(this.veCurrentVideoCallState.interactionId!==e){this.logger.warn("Skipping stoping video, Session ended for different interaction ID",e,this.veCurrentVideoCallState.interactionId);return}this.stopVideo(!0)})}async sendMessageToAgent(e){var r,i;if(!((r=this.contactCenterIntegrationInstance)!=null&&r.sendMessageToAgent))throw new Error("sendMessageToAgent is not Implemented in the contact center integration instance");await((i=this.contactCenterIntegrationInstance)==null?void 0:i.sendMessageToAgent(e))}async startVideoChatSession(e={},r={},i=!1,o=!0){if(this.isCallOngoing){this.showWidget(),this.logger.warn("Call is already ongoing");return}await this.promiseManager.run("startVideoChatSession",async()=>{var u,d,h,S,A,D,M;try{this.veCurrentVideoCallState.startingVideoSession=!0,this.logger.debug("Starting video session",e,r);let C;if(this.setVideoCallConfigs(e),this.veCurrentVideoCallState.isPopup&&this.loadEmptyPopup(),e.shortUrl){const N=await this.getInteractionidFromShortUrl(e.shortUrl);if(!N)throw new Error("Invalid short URL provided");e.interactionId=N.interactionId,C=N.url,this.setVideoCallConfigs(e)}return this.prepareVideoCall(),await this.setCustomAttributes(r),await((d=(u=this.contactCenterIntegrationInstance)==null?void 0:u.preStartVideoEngager)==null?void 0:d.call(u,this.veConnectionConfigs,this.veCurrentVideoCallState)),await this.startVideo(C),await((S=(h=this.contactCenterIntegrationInstance)==null?void 0:h.postStartVideoEngager)==null?void 0:S.call(h,this.veConnectionConfigs,this.veCurrentVideoCallState)),this.veCurrentVideoCallState.startingVideoSession=!1,!0}catch(C){throw this.veCurrentVideoCallState.startingVideoSession=!1,this.logger.error(C),this.captureError(C),this.eventEmitter.emit("videoEngager:error",{severity:"fatal",type:"during-starting-video-session",message:typeof C=="string"?C:C==null?void 0:C.message}),this.logger.debug("Cleaning up after error",C),(A=this.popupInstance)==null||A.close(),this.popupInstance=null,this.destroyIframeInstance(),this.setVeCallState(_e.idle),this.setShouldHaveActiveInstance(!1),o&&((M=(D=this.contactCenterIntegrationInstance)==null?void 0:D.endConversation)==null||M.call(D).catch(N=>{this.logger.error("Error ending conversation",N)})),new Error("Error starting video session: "+(typeof C=="string"?C:C==null?void 0:C.message))}},{conflictsWith:["endVideoChatSession"]})}async endVideoChatSession(){await this.promiseManager.run("endVideoChatSession",async()=>{var e,r;try{this.logger.debug("Ending video session"),this.stopVideo(),await((r=(e=this.contactCenterIntegrationInstance)==null?void 0:e.endConversation)==null?void 0:r.call(e).catch(i=>{this.logger.error("Error ending conversation",i)}))}catch(i){throw this.logger.error("Error ending video session",i),this.captureError(i),this.eventEmitter.emit("videoEngager:error",{severity:"fatal",type:"during-ending-video-session",message:typeof i=="string"?i:i==null?void 0:i.message}),new Error("Error ending video session: "+(typeof i=="string"?i:i==null?void 0:i.message))}},{waitIfRunning:!0,waitFor:["startVideoChatSession"],waitForDelayMs:500})}captureError(e){try{yt.captureException(typeof e=="string"?new Error(e):e,{level:"error",user:{id:this.veConnectionConfigs.tenantId,interactionId:this.veCurrentVideoCallState.interactionId},extra:{interactionId:this.veConnectionConfigs.tenantId,source:(this.customAttributes||{}).source,counter:(this.customAttributes||{}).counter,location:(this.customAttributes||{}).location}})}catch(r){console.error("Error capturing error",r)}}loadEmptyPopup(){if(this.popupInstance=window.open("","videoEngagerInstance","width=800,height=600"),!St(this.popupInstance))throw this.logger.error("Popup blocked. Please allow popups for this site."),new Error("Popup blocked. Please allow popups for this site.");this.setShouldHaveActiveInstance(!0),en(this.popupInstance)}assignUrlToPopup(e){if(!St(this.popupInstance))throw new Error("User has closed the popup");return Xt(this.popupInstance,e)}async startVideo(e){if(e){this.logger.debug("Starting video session with URL override",e),this.eventEmitter.emit("videoEngager:should-open-videoengager",e),await this.loadVideoEngagerPage(e);return}const r={sessionId:this.veCurrentVideoCallState.interactionId,hideChat:!0,type:"initial",defaultGroup:"floor",view_widget:"4",offline:!0,aa:this.veCurrentVideoCallState.autoAccept,skip_private:!0,inichat:"false"};this.veCurrentVideoCallState.audioOnly&&(r.video_on="false");const i=window.btoa(JSON.stringify(r)),u=`${`https://${this.veConnectionConfigs.veEnv}/static/`}popup.html?tennantId=${window.btoa(this.veConnectionConfigs.tenantId)}&params=${i}`;this.eventEmitter.emit("videoEngager:should-open-videoengager",u),await this.loadVideoEngagerPage(u),this.setShouldHaveActiveInstance(!0)}registerPostRobotGlobalListeners(){et.on("VideoEngager.event:StateChanged",async e=>(this.logger.debug("VideoEngager state changedx",e.data),this.checkIfMessageFromVeInstance(e)?(this.currentVeIframeState=e.data||{},this.eventEmitter.emit("videoEngager:iframe-video-state-changed",this.currentVeIframeState),null):(this.logger.warn("Ignoring state change message from unknown source"),null)))}async loadVideoEngagerPage(e){if(this.veCurrentVideoCallState.isPopup)await this.assignUrlToPopup(e);else{if(this.getIframeInstance())throw new Error("Iframe instance already exists, please destroy it before creating a new one");if(await this.createIframe(e),!this.getIframeInstance())throw this.logger.error("Iframe instance not found and could not be created"),this.eventEmitter.emit("videoEngager:error",{severity:"fatal",type:"iframe-not-found",message:"Iframe instance not found and could not be created"}),new Error("Iframe instance not found and could not be created");this.setIframeVisibility(!0)}if(!this.enableVeIframeCommands)return;const r=new Promise((i,o)=>{et.once("VideoEngager.event:Ready",{window:this.getIframeInstance()||void 0,handler:async u=>{this.availableMethods=u.data||{},this.logger.debug("VideoEngager is ready",this.availableMethods),this.currentVeIframeState=this.availableMethods.currentState||{},this.eventEmitter.emit("videoEngager:iframe-connected",this.currentVeIframeState),this.eventEmitter.emit("videoEngager:iframe-video-state-changed",this.currentVeIframeState),i()}})});await Promise.race([r,new Promise((i,o)=>setTimeout(()=>o(new Error("Timeout waiting for VideoEngager to be ready")),24e3))])}async executeVideoCallFn(e,...r){const i=this.availableMethods[e];return typeof i!="function"?Promise.reject(new Error(`Method ${e} not found`)):i(...r)}async createIframe(e){this.logger.debug("Creating iframe instance",e),this.eventEmitter.emit("videoEngager:should-create-iframe",e),await this.uiCallbacks.createIframe(e)}setIframeVisibility(e){var r,i;this.logger.debug("Setting iframe visibility",e),this.eventEmitter.emit("videoEngager:should-set-iframe-visibility",e),(i=(r=this.uiCallbacks)==null?void 0:r.setIframeVisibility)==null||i.call(r,e)}destroyIframeInstance(){var e,r;this.logger.debug("Destroying iframe instance"),this.eventEmitter.emit("videoEngager:should-destroy-iframe-instance"),(r=(e=this.uiCallbacks)==null?void 0:e.destroyIframe)==null||r.call(e)}getIframeInstance(){var e,r,i;return((i=(r=(e=this.uiCallbacks)==null?void 0:e.getIframeInstance)==null?void 0:r.call(e))==null?void 0:i.contentWindow)||null}closeVideoEngagerInstance(){var e;this.logger.debug("Closing video engager instance"),this.isCurrentVeInstanceActive&&((e=this.popupInstance)==null||e.close(),this.popupInstance=null),this.destroyIframeInstance(),this.setVeCallState(_e.idle),this.setShouldHaveActiveInstance(!1),this.eventEmitter.emit("videoEngager:videoSessionEnd"),this.veCurrentVideoCallState.interactionId=null}stopVideo(e=!1){if(!this.isCallOngoing){if(e){this.logger.warn("No active video call to stop");return}throw new Error("No active video call to stop")}this.logger.debug("Stopping video session (Called stopVideo)"),this.eventEmitter.emit("videoEngager:should-close-videoengager"),this.closeVideoEngagerInstance(),this.hideWidget()}destroyInstance(){var e,r;this.logger.debug("Destroying VideoEngagerWidgetCore instance"),(r=(e=this.contactCenterIntegrationInstance)==null?void 0:e.destroyInstance)==null||r.call(e),this.contactCenterIntegrationInstance=void 0,this.veCurrentVideoCallState=le.getDefaultVideoCallState(),this.customAttributes={},this.popupInstance=null,this.eventEmitter.removeAllListeners()}get baseUrl(){return`${this.veConnectionConfigs.veHttps?"https":"http"}://${this.veConnectionConfigs.veEnv}`}async getInteractionidFromShortUrl(e){const r=`${this.baseUrl}/ve/`;if(!e.startsWith(r))return!1;const i=e.split(r)[1].split("/")[0];if(!i)return!1;const o=await fetch(`${this.baseUrl}/api/shorturls/${this.veConnectionConfigs.tenantId}/code/${i}`);if(!o.ok)return this.logger.error("Error fetching interaction ID from short URL",o.statusText),!1;const u=await o.json();if(!u.active)return this.logger.error("Short URL is not active",u),!1;if(new Date(u.expire)<new Date)return this.logger.error("Short URL is expired",u),!1;try{const h=new URL(u.url,this.baseUrl).searchParams.get("params");if(!h)return this.logger.error("No params found in short URL",u),!1;const S=JSON.parse(atob(h));if(!S)return this.logger.error("No params found in short URL",u),!1;const A=S.transferId||S.sessionId;return A?(this.logger.debug("Interaction ID from short URL",A),{interactionId:A,url:u.url}):(this.logger.error("No interaction ID found in short URL",u),!1)}catch(d){return this.logger.error("Error parsing short URL",d),!1}}};le.postRobot=et,le.getDefaultVideoCallState=()=>({interactionId:null,callState:"idle",autoAccept:!0,audioOnly:!1,isPopup:!1,startingVideoSession:!1,popupInstance:null,shouldHaveActiveInstance:!1,endingVideoSession:!1});let tt=le;function an(){function c(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c()}const Pe=Object.freeze({StructuredMessage:"StructuredMessage",string:"string",GetConfigurationResponse:"GetConfigurationResponse",ConnectionClosedEvent:"ConnectionClosedEvent",SessionClearedEvent:"SessionClearedEvent",PresignedUrlResponse:"PresignedUrlResponse",UploadSuccessEvent:"UploadSuccessEvent",UploadFailureEvent:"UploadFailureEvent",GenerateUrlError:"GenerateUrlError",ErrorMessage:"ErrorMessage",TooManyRequestsErrorMessage:"TooManyRequestsErrorMessage",SessionResponse:"SessionResponse"}),Ee=Object.freeze({Text:"Text",Structured:"Structured",Receipt:"Receipt",Event:"Event"});function cn(c,e,r,i={}){const{timeout:o=0,retries:u=0}=i;let d=0,h;const S=new Promise((A,D)=>{h=new XMLHttpRequest,o>0&&(h.timeout=o,h.ontimeout=()=>{D(new Error("Upload timeout"))}),h.upload.addEventListener("progress",C=>{if(C.lengthComputable){const N=C.loaded/C.total*100;r(N,{loaded:C.loaded,total:C.total,computable:!0})}else r(null,{loaded:C.loaded,total:null,computable:!1})}),h.addEventListener("load",()=>{if(h.status>=200&&h.status<300)A({status:h.status,statusText:h.statusText,response:h.response});else{const C=new Error(`HTTP Error: ${h.status}`);if(C.status=h.status,C.statusText=h.statusText,d<u&&h.status>=500){d++,setTimeout(()=>M(),1e3*d);return}D(C)}}),h.addEventListener("error",()=>{if(d<u){d++,setTimeout(()=>M(),1e3*d);return}D(new Error("Network Error"))}),h.addEventListener("abort",()=>{D(new Error("Upload Aborted"))});function M(){h.open("PUT",c.url),Object.keys(c.headers).forEach(C=>{h.setRequestHeader(C,c.headers[C])}),h.send(e)}M()});return S.abort=()=>{h&&h.abort()},S}function nt(c){if(c===null)return"unknown";const e=["B","KB","MB","GB","TB"];let r=0,i=c;for(;i>=1024&&r<e.length-1;)i/=1024,r++;return`${i.toFixed(2)} ${e[r]}`}function At(c){var r,i,o,u,d;if(c.direction==="Inbound")return{name:((r=c.channel.from)==null?void 0:r.nickname)||"You",image:(i=c.channel.from)==null?void 0:i.image};let e="";return(o=c.channel)!=null&&o.from&&(c.channel.from.firstName||c.channel.from.lastName)?e=`${c.channel.from.firstName} ${c.channel.from.lastName}`:(u=c.channel)!=null&&u.from&&c.channel.from.nickname?e=c.channel.from.nickname:c.originatingEntity==="Bot"?e="Bot":e="Agent",{name:e,image:(d=c.channel.from)==null?void 0:d.image}}function un(c){switch(c){case"Image":return"image";case"Video":return"video";case"Audio":return"audio";case"File":return"file";case"Link":return"link";default:return"unknown"}}const Rt={Attachment:c=>({type:"Attachment",attachments:c.map(e=>({id:e.id,type:un(e.mediaType),name:e.filename,size:e.fileSize,url:e.url,mime:e.mime}))}),QuickReply:!1,ButtonResponse:!1,Card:!1,Carousel:!1};function dn(c){var r,i;const e=(i=(r=c.content)==null?void 0:r[0])==null?void 0:i.contentType;return Rt[e]&&Rt[e](c.content)}function ln(c,e){if(!c||typeof c!="string")return null;const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`https://${r}/ve/[^\\s]+`),o=c.match(i);if(!o)return null;let u=o[0];const d=/[.,;:!?)]+$/;u=u.replace(d,"");const h=c.replace(u,"").trim();return{url:u,text:h}}function hn(c,e){var u;let r="text"in c&&!!c.text,i=!!((u=c.content)!=null&&u.length)&&dn(c),o=r&&ln(c.text,e);return r&&i?{...i,text:c.text}:r&&o?{type:"videoEngagerUrl",text:o.text,url:o.url}:r?{type:"Text",text:c.text}:i||{type:"Error",text:"Unsupported message format"}}function fn(c,e){const r=c.channel.time?new Date(c.channel.time):new Date,i=At(c),o=hn(c,e);return{id:c.id,direction:c.direction==="Outbound"?"Inbound":"Outbound",sender:{name:i.name,image:i.image},timestamp:r.toISOString(),content:o}}function gn(c){switch(c){case"Join":return"Joined";case"Disconnect":return"Ended";case"Clear":return"Ended";default:return null}}function mn(c){var u;if(((u=c.events[0])==null?void 0:u.eventType)!=="Presence")return null;const e=gn(c.events[0].presence.type);if(!e)return null;const r=c.channel.time?new Date(c.channel.time):new Date,i=At(c);return{id:c.id,direction:c.direction==="Outbound"?"Inbound":"Outbound",content:{type:"NotificationPresence",presence:e},timestamp:r.toISOString(),sender:{name:i.name,image:i.image}}}function Tt(c,e){var o;if(!(c.type===Ee.Structured||c.type===Ee.Text))return null;const r="text"in c&&!!c.text,i=!!((o=c.content)!=null&&o.length);if(!r&&!i)return null;try{return fn(c,e)}catch(u){return console.error("Error normalizing message:",u),null}}function Mt(c,e){return c.type!==Ee.Event?null:mn(c)}class rt{constructor(e=!1,r){this.debugEnabled=!1,this.name="UnknownLogger",this.debugEnabled=e,this.name=r}setLevel(e){this.debugEnabled=e}debug(...e){this.debugEnabled&&console.debug(`[${this.name}]`,...e)}info(...e){this.debugEnabled&&console.info(`[${this.name}]`,...e)}warn(...e){this.debugEnabled&&console.warn(`[${this.name}]`,...e)}error(...e){console.error(`[${this.name}]`,...e)}log(...e){console.log(`[${this.name}]`,...e)}}const pn={dev:"inindca.com","fedramp-use2-core":"use2.us-gov-pure.cloud",prod:"mypurecloud.com","prod-apne1":"mypurecloud.jp","prod-apne2":"apne2.pure.cloud","prod-apne3":"apne3.pure.cloud","prod-aps1":"aps1.pure.cloud","prod-apse2":"mypurecloud.com.au","prod-cac1":"cac1.pure.cloud","prod-euc1":"mypurecloud.de","prod-euc2":"euc2.pure.cloud","prod-euw1":"mypurecloud.ie","prod-euw2":"euw2.pure.cloud","prod-mec1":"mec1.pure.cloud","prod-sae1":"sae1.pure.cloud","prod-usw2":"usw2.pure.cloud",test:"inindca.com"};var Le=(c=>(c.MESSAGE="message",c.OPEN="open",c.CLOSE="close",c.ERROR="error",c.UPLOAD_SUCCESS="uploadSuccess",c.UPLOAD_FAILURE="uploadFailure",c))(Le||{});class vn{constructor(e){if(this.ws=null,this.token=null,this.messageQueue=[],this.connected=!1,this.eventEmitter=new R,this.on=this.eventEmitter.on.bind(this.eventEmitter),this.once=this.eventEmitter.once.bind(this.eventEmitter),this.off=this.eventEmitter.off.bind(this.eventEmitter),this.removeAllListeners=this.eventEmitter.removeAllListeners.bind(this.eventEmitter),this.deploymentId=e.deploymentId,"domain"in e)this.domain=e.domain;else if(e.environment)this.domain=pn[e.environment];else throw new Error("Either environment or domain must be provided in the configuration.");this.baseWsUrl=`wss://webmessaging.${this.domain}/v1`,this.debug=e.debug||!1,this.logger=new rt(e.debug,"GuestMessagingSdk")}connect(){return new Promise((e,r)=>{try{const i=`${this.baseWsUrl}?deploymentId=${this.deploymentId}`;this.ws=new WebSocket(i),this.ws.onopen=()=>{this.logger.log("WebSocket connection established"),this.connected=!0,this.processQueue(),this.eventEmitter.emit("open"),e()},this.ws.onmessage=o=>{try{const u=JSON.parse(o.data);this.logger.debug("Message received",u),this.eventEmitter.emit("message",u)}catch(u){this.logger.log("Error parsing message",u)}},this.ws.onclose=o=>{this.logger.log("WebSocket connection closed",o),this.connected=!1,this.eventEmitter.emit("close",o)},this.ws.onerror=o=>{this.logger.log("WebSocket error",o),this.eventEmitter.emit("error",o),r(o)}}catch(i){this.logger.log("Error connecting to WebSocket",i),r(i)}})}processQueue(){if(!(!this.connected||!this.ws))for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();e&&this.sendRaw(e.action,e.payload,e.tracingId)}}sendRaw(e,r,i){if(!this.connected||!this.ws){this.logger.log("WebSocket not connected, queuing message",e,r),this.messageQueue.push({action:e,payload:r,tracingId:i});return}const o=JSON.stringify({action:e,...r,tracingId:i});this.logger.log("Sending message",o),this.ws.send(o)}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const r=Math.random()*16|0;return(e==="x"?r:r&3|8).toString(16)})}getConfiguration(){const e=this.generateUUID();return new Promise((r,i)=>{const o=u=>{u.tracingId===e&&(this.off("message",o),u.class===Pe.GetConfigurationResponse?r(u.body):i(new Error("Failed to get configuration")))};this.on("message",o),this.sendRaw("getConfiguration",{deploymentId:this.deploymentId},e)})}configureSession(e,r){this.token=e;const i=this.generateUUID();return new Promise((o,u)=>{const d=h=>{if(h.tracingId===i&&h.type==="response"&&h.class==="SessionResponse")if(this.off("message",d),h.code===200&&h.body.connected)o(h.body);else{const S=typeof h.body=="string"?new Error(h.body):new Error("Failed to configure session");u(S)}};this.on("message",d),this.sendRaw("configureSession",{deploymentId:this.deploymentId,token:e,...r?{startNew:r}:{}},i)})}configureAuthenticatedSession(e,r,i){this.token=e;const o=this.generateUUID();return new Promise((u,d)=>{const h=S=>{if(S.tracingId===o&&S.type==="response"&&S.class==="SessionResponse")if(this.off("message",h),S.code===200&&S.body.connected)u(S.body);else{const A=typeof S.body=="string"?new Error(S.body):new Error("Failed to configure session");d(A)}};this.on("message",h),this.sendRaw("configureAuthenticatedSession",{deploymentId:this.deploymentId,token:e,data:{code:r},...i?{startNew:i}:{}},o)})}sendJoinEvent(e){if(!this.token)return Promise.reject(new Error("Session not configured"));const r=this.generateUUID();return new Promise((i,o)=>{const u=d=>{var h,S,A;d.tracingId===r&&(this.off("message",u),d.class===Pe.StructuredMessage&&d.body.type===Ee.Event&&((S=(h=d.body.events)==null?void 0:h[0])==null?void 0:S.eventType)==="Presence"&&((A=d.body.events[0].presence)==null?void 0:A.type)==="Join"?i(d.body):(this.logger.error("Failed to send join event",d),o(new Error("Failed to send join event"))))};this.on("message",u),this.sendRaw("onMessage",{token:this.token,message:{type:"Event",events:[{eventType:"Presence",presence:{type:"Join"}}],...e?{channel:{metadata:{customAttributes:e}}}:{}}},r)})}sendTypingIndicator(){return this.token?new Promise(e=>{this.sendRaw("onMessage",{token:this.token,message:{type:"Event",events:[{eventType:"Typing",typing:{type:"On"}}]}},this.generateUUID()),e()}):Promise.reject(new Error("Session not configured"))}sendTextMessage(e,r){if(!this.token)return Promise.reject(new Error("Session not configured"));const i=this.generateUUID();return new Promise((o,u)=>{const d=h=>{h.tracingId===i&&(this.off("message",d),h.class==="StructuredMessage"&&h.body.type==="Text"&&h.body.direction==="Inbound"?o(h.body):(this.logger.error("Failed to send message",h),u(new Error("Failed to send message"))))};this.on("message",d),this.sendRaw("onMessage",{token:this.token,message:{type:"Text",text:e,...r?{channel:{metadata:{customAttributes:r}}}:{}}},i)})}requestAttachmentUrl(e,r,i){if(!this.token)return Promise.reject(new Error("Session not configured"));const o=this.generateUUID();return new Promise((u,d)=>{const h=S=>{S.tracingId===o&&(this.off("message",h),S.type==="response"&&S.class==="PresignedUrlResponse"?S.code===200?u(S.body):d(new Error(S.body)):(this.logger.error("Failed to request attachment URL",S),d(new Error("Failed to request attachment URL"))))};this.on("message",h),this.sendRaw("onAttachment",{token:this.token,fileName:e,fileType:r,fileSize:i},o)})}uploadAttachment(e,r){return new Promise((i,o)=>{const u=h=>{h.type==="message"&&h.class==="UploadSuccessEvent"&&(this.off("message",d),this.off("message",u),i({attachmentId:h.body.attachmentId,downloadUrl:h.body.downloadUrl}))},d=h=>{h.type==="message"&&h.class==="UploadFailureEvent"&&(this.off("message",u),this.off("message",d),o(new Error(`Upload failed: ${h.body.errorMessage}`)))};this.on("message",u),this.on("message",d),cn(e,r,(h,S)=>{S.computable?this.logger.log(`${h.toFixed(2)}% (${nt(S.loaded)}/${nt(S.total)})`):this.logger.log(`Uploaded ${nt(S.loaded)} (total size unknown)`)}).catch(h=>{this.off("message",u),this.off("message",d),o(h)})})}sendMessageWithAttachment(e,r){if(!this.token)return Promise.reject(new Error("Session not configured"));const i=this.generateUUID();return new Promise((o,u)=>{const d=h=>{h.tracingId===i&&(this.off("message",d),h.code===200?o(h.body):(this.logger.error("Failed to send message with attachment",h),u(new Error("Failed to send message with attachment"))))};this.on("message",d),this.sendRaw("onMessage",{token:this.token,message:{type:"Text",text:e,content:[{contentType:"Attachment",attachment:{id:r}}]}},i)})}getAttachmentUrl(e){if(!this.token)return Promise.reject(new Error("Session not configured"));const r=this.generateUUID();return new Promise((i,o)=>{const u=d=>{d.tracingId===r&&(d.type==="response"?(this.off("message",u),d.code===200?i(d.body.url):o(new Error(d.body))):(this.logger.error("Failed to get attachment URL",d),o(new Error("Failed to get attachment URL"))))};this.on("message",u),this.sendRaw("getAttachment",{token:this.token,attachmentId:e},r)})}deleteAttachment(e){if(!this.token)return Promise.reject(new Error("Session not configured"));const r=this.generateUUID();return new Promise((i,o)=>{const u=d=>{d.tracingId===r&&(d.type==="response"?(this.off("message",u),d.code===200?i():o(new Error(d.body))):(this.logger.error("Failed to delete attachment",d),o(new Error("Failed to delete attachment"))))};this.on("message",u),this.sendRaw("deleteAttachment",{token:this.token,attachmentId:e},r)})}sendQuickReply(e,r){if(!this.token)return Promise.reject(new Error("Session not configured"));const i=this.generateUUID();return new Promise((o,u)=>{const d=h=>{h.tracingId===i&&(h.type==="message"&&h.class==="StructuredMessage"&&h.body.direction==="Inbound"?(this.off("message",d),o(h.body)):(this.logger.error("Failed to send quick reply",h),u(new Error("Failed to send quick reply"))))};this.on("message",d),this.sendRaw("onMessage",{token:this.token,message:{type:"Text",content:[{contentType:"ButtonResponse",buttonResponse:{text:e,type:"QuickReply",payload:r}}]}},i)})}sendClearEvent(){if(!this.token)return Promise.reject(new Error("Session not configured"));const e=this.generateUUID();return new Promise((r,i)=>{const o=d=>{var h,S,A;d.tracingId===e&&(this.off("message",o),clearTimeout(u),d.type==="message"&&(d.class==="StructuredMessage"&&((S=(h=d.body.events)==null?void 0:h[0])==null?void 0:S.eventType)==="Presence"&&((A=d.body.events[0].presence)==null?void 0:A.type)==="Clear"||d.class==="SessionClearedEvent")?r(d.body):(this.logger.error("Failed to send clear event",d),i(new Error("Failed to send clear event"))))};let u=setTimeout(()=>{this.off("message",o),this.logger.error("Timeout waiting for clear event response"),i(new Error("Timeout waiting for clear event response"))},5e3);this.on("message",o),this.sendRaw("onMessage",{token:this.token,message:{type:"Event",events:[{eventType:"Presence",presence:{type:"Clear"}}]}},e)})}closeSession(e=!1){if(!this.token)return Promise.reject(new Error("Session not configured"));const r=this.generateUUID();return new Promise((i,o)=>{const u=d=>{d.tracingId===r&&(d.class==="SessionResponse"?(this.off("message",u),d.code===200?i():o(new Error(d.body))):(this.logger.error("Failed to close session",d),o(new Error("Failed to close session"))))};this.on("message",u),this.sendRaw("closeSession",{token:this.token,closeAllConnections:e},r)})}getJwt(){if(!this.token)return Promise.reject(new Error("Session not configured"));const e=this.generateUUID();return new Promise((r,i)=>{const o=u=>{u.tracingId===e&&(u.type==="response"?(this.off("message",o),"code"in u&&u.code===200?r(u.body.jwt):i(new Error(u.body))):(this.logger.error("Failed to get JWT",u),i(new Error("Failed to get JWT"))))};this.on("message",o),this.sendRaw("getJwt",{token:this.token},e)})}async getMessageHistory(e,r=100,i=1){const u=`https://api.${this.domain.replace("webmessaging.","")}/api/v2/webmessaging/messages?pageSize=${r}&pageNumber=${i}`,d=await fetch(u,{headers:{Authorization:`Bearer ${e}`,Origin:window.location.origin}});if(!d.ok)throw new Error(`Failed to retrieve message history: ${d.statusText}`);return d.json()}echo(){const e=this.generateUUID();return new Promise((r,i)=>{const o=u=>{u.tracingId===e&&u.type==="response"&&u.class==="StructuredMessage"&&u.code===200&&(this.off("message",o),r())};this.on("message",o),this.sendRaw("echo",{message:{type:"Text",text:"ping"}},e)})}disconnect(){this.ws&&(this.ws.close(),this.ws=null,this.connected=!1)}}const T={STATE_CHANGE:"stateChange",MESSAGE:"message",ERROR:"error",CONNECTED:"connected",DISCONNECTED:"disconnected",SESSION_CONFIGURED:"sessionConfigured",CONVERSATION_STARTED:"conversationStarted",CONVERSATION_ENDED:"conversationEnded",READ_ONLY:"readOnly",OFFLINE:"offline",ONLINE:"online"};class En{constructor(e){this.token=null,this.autoReconnect=!0,this.reconnectInterval=5e3,this.reconnectAttempts=0,this.maxReconnectAttempts=20,this.reconnectTimeoutId=null,this.connectionState="disconnected",this.messageQueue=[],this.sessionInfo=null,this.eventEmitter=new R,this._shouldAutoReconnect=!1,this.on=this.eventEmitter.on.bind(this.eventEmitter),this.once=this.eventEmitter.once.bind(this.eventEmitter),this.off=this.eventEmitter.off.bind(this.eventEmitter),this.removeAllListeners=this.eventEmitter.removeAllListeners.bind(this.eventEmitter),this.config=e,this.sdk=new vn(e),this.logger=new rt(e.debug,"GenesysMessaging"),this.setupEventHandlers()}setupEventHandlers(){let e,r=!1;const i=(o=!1)=>{r!==o&&(r=o,e&&clearInterval(e),o&&(e=setInterval(()=>{this.sdk.echo().catch(u=>{this.eventEmitter.emit(T.ERROR,u)})},3e4)))};this.on(T.STATE_CHANGE,o=>{o==="disconnected"?i(!1):o==="configured"&&i(!0)}),this.sdk.on(Le.MESSAGE,o=>{var u,d,h,S,A,D,M,C,N,F;o.class===Pe.StructuredMessage&&((u=o.body)==null?void 0:u.type)===Ee.Event&&((S=(h=(d=o.body)==null?void 0:d.events)==null?void 0:h[0])==null?void 0:S.eventType)==="Presence"&&((A=o.body.events[0].presence)==null?void 0:A.type)==="Disconnect"?(this._shouldAutoReconnect=!1,this.token=null,this.sessionInfo=null,this.updateState("readOnly"),this.disconnect()):o.type==="message"&&o.class==="SessionClearedEvent"?(this.token=null,this._shouldAutoReconnect=!1,this.token=null,this.sessionInfo=null,this.updateState("readOnly"),this.disconnect()):o.class===Pe.StructuredMessage&&((D=o.body)==null?void 0:D.type)===Ee.Event&&((N=(C=(M=o.body)==null?void 0:M.events)==null?void 0:C[0])==null?void 0:N.eventType)==="Presence"&&((F=o.body.events[0].presence)==null?void 0:F.type)==="Clear"?(this.token=null,this._shouldAutoReconnect=!1,this.sessionInfo=null,this.updateState("readOnly"),this.disconnect()):o.type==="message"&&o.class==="ConnectionClosedEvent"||o.type==="message"&&this.eventEmitter.emit(T.MESSAGE,o)}),this.sdk.on(Le.OPEN,()=>{this.updateState("connected"),this.reconnectAttempts=0,this.eventEmitter.emit(T.CONNECTED)}),this.sdk.on(Le.CLOSE,o=>{i(!1),this.isInState("readOnly")&&(this.token=null,this.eventEmitter.emit(T.CONVERSATION_ENDED,o));const d=this.isInAnyState("configured","inConversation")&&this.token!==null;this.updateState("disconnected"),console.debug("Connection closed:",{event:o,wasConfigured:d,token:this.token,sessionInfo:this.sessionInfo,connectionState:this.connectionState,reconnectAttempts:this.reconnectAttempts,maxReconnectAttempts:this.maxReconnectAttempts,autoReconnect:this.autoReconnect,shouldAutoReconnect:this._shouldAutoReconnect,reconnectInterval:this.reconnectInterval,messageQueue:this.messageQueue}),d&&this._shouldAutoReconnect&&this.autoReconnect&&this.reconnectAttempts<this.maxReconnectAttempts&&(this.logger.debug("Attempting to reconnect..."),this.eventEmitter.emit(T.OFFLINE),this.scheduleReconnect(d,this.token))}),this.sdk.on(Le.ERROR,o=>{this.updateState("error"),this.eventEmitter.emit(T.ERROR,o)})}updateState(e){this.logger.debug("State change:",this.connectionState,"->",e);const r=this.connectionState!==e,i=this.connectionState;if(this.connectionState=e,r&&this.eventEmitter.emit(T.STATE_CHANGE,e,i),r&&e==="readOnly"&&this.eventEmitter.emit(T.READ_ONLY,this.sessionInfo||{readOnly:!0}),r&&e==="disconnected"){const o={type:"close",wasClean:!0};this.eventEmitter.emit(T.DISCONNECTED,o)}}scheduleReconnect(e=!1,r){this.reconnectTimeoutId!==null&&clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=window.setTimeout(async()=>{this.reconnectAttempts++;try{await this.connect(),e&&r===this.token&&this.token&&(this.logger.debug("Reconfiguring session because of scheduled reconnect:",this.token),await this.configureSession(this.token),this.eventEmitter.emit(T.ONLINE))}catch(i){this.eventEmitter.emit(T.ERROR,i),this.reconnectAttempts<this.maxReconnectAttempts&&(this.logger.debug("Reconnection attempt failed. Retrying..."),this.scheduleReconnect(e,r))}},this.reconnectInterval)}getState(){return this.connectionState}isInState(e){return this.connectionState===e}isInAnyState(...e){return e.some(r=>this.isInState(r))}isReadyToSendMessages(){return this.connectionState==="configured"||this.connectionState==="inConversation"}async ensureConnectionReady(e,...r){if(this.isInState("readOnly"))throw new Error("Session is in read-only mode. Start a new session to continue messaging.");if(!this.isReadyToSendMessages())if(this.isInState("disconnected")){if(!this.token)throw new Error("Not connected and no token available. Connect and configure a session first.");return new Promise((i,o)=>{this.logger.debug("Queueing method:",e.name,"with args:",r),this.messageQueue.push({method:e.name,args:r}),this.connect().then(()=>{this.logger.debug("Reconnecting and reconfiguring session:",this.token),this.configureSession(this.token)}).then(()=>{}).catch(o)})}else throw new Error(`Connection not ready (current state: ${this.connectionState}). Wait for the configured state.`);return e.apply(this,r)}processQueue(){for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();if(!e)continue;this.logger.debug("Processing queued method:",e.method,"with args:",e.args);const r=this[e.method];typeof r=="function"&&r.apply(this,e.args).catch(i=>this.eventEmitter.emit(T.ERROR,i))}}connect(){return this._shouldAutoReconnect=!0,this.isInState("connected")||this.isInState("configured")||this.isInState("inConversation")?Promise.resolve():(this.updateState("connecting"),this.sdk.connect())}disconnect(){this._shouldAutoReconnect=!1,this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.reconnectInterval,this.sdk.disconnect()}getConfiguration(){return this.sdk.getConfiguration()}async configureSession(e,r=!1){this.isInState("connected")||await new Promise(o=>{this.once(T.CONNECTED,()=>{o(!0)})}),this.token=e,this.updateState("configuring"),this.logger.debug("Configuring session with token:",e,this.connectionState);const i=await this.sdk.configureSession(e,r);return this.logger.debug("Session configured:",i,this.getState()),this.sessionInfo=i,i.readOnly===!0?this.updateState("readOnly"):(this.updateState("configured"),this.eventEmitter.emit(T.SESSION_CONFIGURED,i),this.processQueue()),i}async configureAuthenticatedSession(e,r,i=!1){this.token=e,this.updateState("configuring");const o=await this.sdk.configureAuthenticatedSession(e,r,i);return this.sessionInfo=o,o.readOnly?(this.updateState("readOnly"),this.eventEmitter.emit(T.READ_ONLY,o)):(this.updateState("configured"),this.eventEmitter.emit(T.SESSION_CONFIGURED,o),this.processQueue()),o}sendJoinEvent(e){return this.ensureConnectionReady(async()=>{const r=await this.sdk.sendJoinEvent(e);return this.updateState("inConversation"),this.eventEmitter.emit(T.CONVERSATION_STARTED,r),r})}sendMessage(e,r){return this.ensureConnectionReady(async()=>{const i=await this.sdk.sendTextMessage(e,r);return this.isInState("inConversation")||(this.updateState("inConversation"),this.eventEmitter.emit(T.CONVERSATION_STARTED,i)),i})}sendTypingIndicator(){return this.ensureConnectionReady(()=>this.sdk.sendTypingIndicator())}sendFileMessage(e,r){return this.ensureConnectionReady(async()=>{try{this.logger.debug("Sending file message:",e,r),this.logger.debug("1. Requesting presigned URL for file upload...");const i=await this.sdk.requestAttachmentUrl(r.name,r.type,r.size);this.logger.debug("2. Uploading file to presigned URL...");const o=await this.sdk.uploadAttachment(i,r);this.logger.debug("3. Sending message with attachment...");const u=await this.sdk.sendMessageWithAttachment(e,o.attachmentId);return this.logger.debug("File message sent successfully:",u),this.isInState("inConversation")||(this.updateState("inConversation"),this.eventEmitter.emit(T.CONVERSATION_STARTED,u)),u}catch(i){throw i}})}sendQuickReply(e,r){return this.ensureConnectionReady(()=>this.sdk.sendQuickReply(e,r))}async clearConversation(){return this.token?await this.sdk.sendClearEvent():Promise.reject(new Error("Session not configured"))}async closeSession(e=!1){if(!this.token)return Promise.reject(new Error("Session not configured"));await this.sdk.closeSession(e),this.token=null,this.sessionInfo=null}getJwtToken(){return this.token?this.sdk.getJwt():Promise.reject(new Error("Session not configured"))}async getMessageHistory(e,r=100,i=1){try{const o=e||await this.getJwtToken();return await this.sdk.getMessageHistory(o,r,i)}catch(o){throw o}}checkConnectionHealth(){return this.sdk.echo()}startNewSession(){return this.token?this.configureSession(this.token,!0):Promise.reject(new Error("No previous session token available"))}isReadOnly(){return this.isInState("readOnly")}getSessionInfo(){return this.sessionInfo}}const Be=class Be{constructor(e){if(this.integrationName="genesys",this.genesysLoaded=!1,this.interactionId=null,this.errorRegistered=!1,this.startingGenesysVideoSession=!1,this.messages=[],this.messagesObject={},this.customAttributes={},this.inActiveConversation=!1,this.capabilities={supportsMidConversationAttributeUpdates:!0,supportsMidConversationInteractionIdUpdates:!0},this.setEventEmitter=r=>{this.eventEmitter=r},this.attributeChangeMessage="Conversation Data Updated",this.lastStartTime=0,this.sendMessageToAgent=async r=>await this.genesysMessaging.sendMessage(r),this.sendAttachmentToAgent=async(r,i)=>await this.genesysMessaging.sendFileMessage(i||"Attachment",r),this.config=e,!this.config)throw new Error("GenesysIntegration: config is not set");this.genesysMessaging=new En(this.config),this.logger=new rt(this.config.debug,"GenesysIntegrationPureSocket"),this.promiseManager=new ze(this.logger)}getCustomAttributes(){return this.customAttributes}setCustomAttributes(e){if(this.inActiveConversation)throw new Error("Cannot set custom attributes in active conversation");return this.customAttributes=e,this.eventEmitter.emit("integration:customAttributesUpdated",e),Promise.resolve()}async updateCustomAttributes(e,r=!1){return Object.assign(this.customAttributes,e),r&&await this._updateAttributesInGenesys({"context.veVisitorId":this.interactionId||"0"}),this.eventEmitter.emit("integration:customAttributesUpdated",e),Promise.resolve()}setVeInteractionId(e){if(this.inActiveConversation)throw new Error("Cannot set interaction ID in active conversation");return this.interactionId=e,this.customAttributes["context.veVisitorId"]=e,this.eventEmitter.emit("integration:interactionIdUpdated",e),Promise.resolve()}async updateVeInteractionId(e,r=!1){if(this.interactionId=e,this.customAttributes["context.veVisitorId"]=e||"0",r){const i=(e?this.callStartedMessage:this.callEndedMessage)||this.attributeChangeMessage;await this._updateAttributesInGenesys({"context.veVisitorId":e||"0"},i)}return this.eventEmitter.emit("integration:interactionIdUpdated",e),Promise.resolve()}async _updateAttributesInGenesys(e,r){await this.promiseManager.run("updateAttributesInGenesys",async i=>{if(!this.genesysMessaging.isReadyToSendMessages())throw new Error("Cannot update interaction ID in inactive conversation");await this.genesysMessaging.sendMessage(r||"Conversation Data Updated",{...this.customAttributes,...e})},{waitIfRunning:!0,waitForDelayMs:1e3,waitFor:["sendJoinEvent"]})}getActiveVeInteractionId(){return this.interactionId==="0"?Promise.resolve(null):Promise.resolve(this.interactionId)}async init(e,r){try{if(this.genesysLoaded)return;this.veConnectionConfings=e,this.currentInitialization=this.initializeGenesys(),await this.currentInitialization,this.genesysLoaded=!0,this.eventEmitter.emit("integration:loaded",this.integrationName),this.eventEmitter.on("videoEngager:videoSessionEnd",async()=>{await new Promise(i=>{setTimeout(()=>{i(!0)},200)}),this.inActiveConversation&&this.genesysMessaging.isReadyToSendMessages()&&this.updateVeInteractionId(null,!0).catch(i=>{this.logger.error("Error updating interaction ID:",i)})})}catch(i){throw this.logger.error("Error initializing Genesys integration:",i),this.eventEmitter.emit("error",{severity:"fatal",type:"initialization-failed",message:typeof i=="string"?i:(i==null?void 0:i.message)||"Unknown error"}),i}}async initializeGenesys(){this.currentInitialization&&await this.currentInitialization,this.startingGenesysVideoSession=!1,this.interactionId=null,this.registerGenesysListeners()}async startNewConversation(e,r,i=!1){await this.genesysMessaging.connect(),this.logger.log("Connected to Genesys Cloud");const o=`user-${Math.random().toString(36).substring(2,15)}`,u=await this.genesysMessaging.configureSession(o);this.logger.debug("Session configured:",u),this.logger.debug("about to send join event:",JSON.stringify({veCallState:r,"this.interactionId":this.interactionId},null,2)),await this.promiseManager.run("sendJoinEvent",async d=>{await this.genesysMessaging.sendJoinEvent({...this.customAttributes||{},"context.veVisitorId":this.interactionId})},{}),r.firstMessage&&await this.sendMessageToAgent(r.firstMessage).catch(d=>{this.logger.error("Error sending message to agent:",d)})}async preStartVideoEngager(e,r){return this.logger.debug("preStartVideoEngager called"),this.promiseManager.run("preStartVideoEngager",async i=>{if(!r.interactionId)throw new Error("Interaction ID is not set in the call state");this.callEndedMessage=r.callEndedMessage,this.callStartedMessage=r.callStartedMessage,r.attributeChangeMessage&&(this.attributeChangeMessage=r.attributeChangeMessage),this.inActiveConversation&&this.genesysMessaging.isReadyToSendMessages()?(this.logger.debug("Already in active conversation, updating interaction ID",r,this.interactionId),r.interactionId!==await this.getActiveVeInteractionId()?await this.updateVeInteractionId(r.interactionId,!0):this.logger.debug("Already in active conversation with the same interaction ID",r,this.interactionId)):(this.logger.debug("Starting new Genesys video session",r,this.interactionId),await this.setVeInteractionId(r.interactionId),await this.startNewConversation(e,r)),this.logger.debug("Genesys Chat session started successfully",this.interactionId),this.lastStartTime=Date.now()},{waitFor:["endConversation"],waitForDelayMs:200})}async postStartVideoEngager(e,r){localStorage.setItem("ve_last_interaction",this.interactionId),this.startingGenesysVideoSession=!1}addNewMessageToList(e,r=!1){e&&(this.messagesObject[e.id]||(this.messagesObject[e.id]=e,this.messages.push(e),r?this.eventEmitter.emit("integration:notification",e):this.eventEmitter.emit("integration:message",e)))}registerGenesysListeners(){this.genesysMessaging.on(T.MESSAGE,e=>{e.class===Pe.StructuredMessage&&!this.messagesObject[e.body.id||""]&&(this.addNewMessageToList(Tt(e.body,this.veConnectionConfings.veEnv)),this.addNewMessageToList(Mt(e.body,this.veConnectionConfings.veEnv),!0))}),this.genesysMessaging.on(T.ERROR,e=>{this.logger.error("Error occurred:",e)}),this.genesysMessaging.on(T.SESSION_CONFIGURED,e=>{this.logger.log("Session configured:",e)}),this.genesysMessaging.on(T.CONVERSATION_STARTED,()=>{this.logger.log("Conversation started!"),this.inActiveConversation=!0,this.eventEmitter.emit("integration:sessionStarted")}),this.genesysMessaging.on(T.CONVERSATION_ENDED,()=>{this.logger.log("Conversation ended!"),this.inActiveConversation=!1,this.eventEmitter.emit("integration:sessionEnded",this.interactionId)})}async closeSession(e=!1){return this.promiseManager.run("closeSession",async r=>{this.genesysMessaging&&this.genesysMessaging.isReadyToSendMessages()&&(await this.genesysMessaging.closeSession(e),this.genesysMessaging.disconnect(),this.inActiveConversation=!1)},{timeoutMs:2e3,conflictsWith:["endConversation"]})}async endConversation(){return this.promiseManager.run("endConversation",async e=>{var i;const r=this.interactionId;if(this.lastStartTime&&Date.now()-this.lastStartTime<2e3&&await new Promise(o=>setTimeout(()=>{o(!0)},2e3-(Date.now()-this.lastStartTime))),!this.inActiveConversation){this.logger.warn("No active conversation to end");return}await((i=this.genesysMessaging)==null?void 0:i.clearConversation().catch(o=>{this.logger.warn("Error ending conversation:",o)})),this.inActiveConversation=!1,this.eventEmitter.emit("integration:sessionEnded",r)},{waitFor:["preStartVideoEngager"],waitForDelayMs:2e3,waitIfRunning:!0,timeoutMs:5e3})}async cleanup(){this.genesysMessaging&&(await this.genesysMessaging.clearConversation().catch(e=>{this.logger.warn("Error clearing conversation:",e)}),this.genesysLoaded=!1,this.interactionId=null,this.eventEmitter.emit("integration:unloaded",this.integrationName))}async destroyInstance(){this.inActiveConversation&&await this.genesysMessaging.clearConversation().catch(e=>{this.logger.warn("Error clearing conversation:",e)}),this.genesysMessaging.sdk.disconnect(),this.genesysLoaded=!1,this.interactionId=null,this.eventEmitter.emit("integration:unloaded",this.integrationName),this.eventEmitter.removeAllListeners("intagration:*"),this.genesysMessaging.removeAllListeners(),this.genesysMessaging.sdk.removeAllListeners()}};Be.parseMessageIfExist=Tt,Be.parseNotificationIfExists=Mt;let it=Be;de.GenesysIntegrationPureSocket=it,de.VideoEngagerCore=tt,Object.defineProperty(de,Symbol.toStringTag,{value:"Module"})});
